<div class="container">

<table style="width: 100%;"><tr>
<td>db_tbl</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Get a table from a database</h2>

<h3>Description</h3>

<p>If your target table is in a database, the <code>db_tbl()</code> function is a handy way
of accessing it. This function simplifies the process of getting a <code>tbl_dbi</code>
object, which usually involves a combination of building a connection to a
database and using the <code>dplyr::tbl()</code> function with the connection and the
table name (or a reference to a table in a schema). You can use <code>db_tbl()</code> as
the basis for obtaining a database table for the <code>tbl</code> parameter in
<code>create_agent()</code> or <code>create_informant()</code>. Another great option is supplying a
table-prep formula involving <code>db_tbl()</code> to <code>tbl_store()</code> so that you have
access to database tables though single names via a table store.
</p>
<p>The username and password are supplied through environment variable names. If
desired, values for the username and password can be supplied directly by
enclosing such values in <code>I()</code>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">db_tbl(
  table,
  dbtype,
  dbname = NULL,
  host = NULL,
  port = NULL,
  user = NULL,
  password = NULL,
  bq_project = NULL,
  bq_dataset = NULL,
  bq_billing = bq_project
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>table</code></td>
<td>
<p>The name of the table, or, a reference to a table in a schema
(two-element vector with the names of schema and table). Alternatively,
this can be supplied as a data table to copy into an in-memory database
connection. This only works if: (1) the <code>db</code> is chosen as either <code>"sqlite"</code>
or <code>"duckdb"</code>, (2) the <code>dbname</code> was is set to <code>":memory:"</code>, and (3) the
object supplied to <code>table</code> is a data frame or a tibble object.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dbtype</code></td>
<td>
<p>Either an appropriate driver function (e.g.,
<code>RPostgres::Postgres()</code>) or a shortname for the database type. Valid names
are: <code>"postgresql"</code>, <code>"postgres"</code>, or <code>"pgsql"</code> (PostgreSQL, using the
<code>RPostgres::Postgres()</code> driver function); <code>"mysql"</code> (MySQL, using
<code>RMySQL::MySQL()</code>); <code>bigquery</code> or <code>bq</code> (BigQuery, using
<code>bigrquery::bigquery()</code>); <code>"duckdb"</code> (DuckDB, using <code>duckdb::duckdb()</code>);
and <code>"sqlite"</code> (SQLite, using <code>RSQLite::SQLite()</code>).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dbname</code></td>
<td>
<p>The database name.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>host, port</code></td>
<td>
<p>The database host and optional port number.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>user, password</code></td>
<td>
<p>The environment variables used to access the username
and password for the database. Enclose in <code>I()</code> when using literal username
or password values.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bq_project, bq_dataset, bq_billing</code></td>
<td>
<p>If accessing a table from a
<em>BigQuery</em> data source, there's the requirement to provide the table's
associated project (<code>bq_project</code>) and dataset (<code>bq_dataset</code>) names. By
default, the project to be billed will be the same as the one provided for
<code>bq_project</code> but the <code>bq_billing</code> argument can be changed to reflect a
different BigQuery project.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A <code>tbl_dbi</code> object.
</p>


<h3>Examples</h3>



<h4>Obtaining in-memory database tables</h4>

<p>You can use an in-memory database table and by supplying it with an in-memory
table. This works with the DuckDB database and the key thing is to use
<code>dbname = ":memory"</code> in the <code>db_tbl()</code> call.
</p>
<div class="sourceCode r"><pre>small_table_duckdb &lt;- 
  db_tbl(
    table = small_table,
    dbtype = "duckdb",
    dbname = ":memory:"
  )

small_table_duckdb
</pre></div>
<pre>## # Source:   table&lt;small_table&gt; [?? x 8]
## # Database: duckdb_connection
##    date_time           date           a b         c      d e     f    
##    &lt;dttm&gt;              &lt;date&gt;     &lt;int&gt; &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;lgl&gt; &lt;chr&gt;
##  1 2016-01-04 11:00:00 2016-01-04     2 1-bc…     3  3423. TRUE  high 
##  2 2016-01-04 00:32:00 2016-01-04     3 5-eg…     8 10000. TRUE  low  
##  3 2016-01-05 13:32:00 2016-01-05     6 8-kd…     3  2343. TRUE  high 
##  4 2016-01-06 17:23:00 2016-01-06     2 5-jd…    NA  3892. FALSE mid  
##  5 2016-01-09 12:36:00 2016-01-09     8 3-ld…     7   284. TRUE  low  
##  6 2016-01-11 06:15:00 2016-01-11     4 2-dh…     4  3291. TRUE  mid  
##  7 2016-01-15 18:46:00 2016-01-15     7 1-kn…     3   843. TRUE  high 
##  8 2016-01-17 11:27:00 2016-01-17     4 5-bo…     2  1036. FALSE low  
##  9 2016-01-20 04:30:00 2016-01-20     3 5-bc…     9   838. FALSE high 
## 10 2016-01-20 04:30:00 2016-01-20     3 5-bc…     9   838. FALSE high 
## # … with more rows</pre>
<p>The in-memory option also works using the SQLite database. The only change
required is setting the <code>dbtype</code> to <code>"sqlite"</code>:
</p>
<div class="sourceCode r"><pre>small_table_sqlite &lt;- 
  db_tbl(
    table = small_table,
    dbtype = "sqlite",
    dbname = ":memory:"
  )

small_table_sqlite
</pre></div>
<pre>## # Source:   table&lt;small_table&gt; [?? x 8]
## # Database: sqlite 3.37.0 [:memory:]
##     date_time  date     a b             c      d     e f    
##         &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;
##  1 1451905200 16804     2 1-bcd-345     3  3423.     1 high 
##  2 1451867520 16804     3 5-egh-163     8 10000.     1 low  
##  3 1452000720 16805     6 8-kdg-938     3  2343.     1 high 
##  4 1452100980 16806     2 5-jdo-903    NA  3892.     0 mid  
##  5 1452342960 16809     8 3-ldm-038     7   284.     1 low  
##  6 1452492900 16811     4 2-dhe-923     4  3291.     1 mid  
##  7 1452883560 16815     7 1-knw-093     3   843.     1 high 
##  8 1453030020 16817     4 5-boe-639     2  1036.     0 low  
##  9 1453264200 16820     3 5-bce-642     9   838.     0 high 
## 10 1453264200 16820     3 5-bce-642     9   838.     0 high 
## # … with more rows</pre>
<p>It's also possible to obtain a table from a remote file and shove it into an
in-memory database. For this, we can use the all-powerful <code>file_tbl()</code> +
<code>db_tbl()</code> combo.
</p>
<div class="sourceCode r"><pre>all_revenue_large_duckdb &lt;-
  db_tbl(
    table = file_tbl(
      file = from_github(
        file = "sj_all_revenue_large.rds",
        repo = "rich-iannone/intendo",
        subdir = "data-large"
      )
    ),
    dbtype = "duckdb",
    dbname = ":memory:"
  )
  
all_revenue_large_duckdb
</pre></div>
<pre>## # Source:   table&lt;sj_all_revenue_large.rds&gt; [?? x 11]
## # Database: duckdb_connection
##    player_id       session_id   session_start       time               
##    &lt;chr&gt;           &lt;chr&gt;        &lt;dttm&gt;              &lt;dttm&gt;             
##  1 IRZKSAOYUJME796 IRZKSAOYUJM… 2015-01-01 00:18:41 2015-01-01 00:18:53
##  2 CJVYRASDZTXO674 CJVYRASDZTX… 2015-01-01 01:13:01 2015-01-01 01:13:07
##  3 CJVYRASDZTXO674 CJVYRASDZTX… 2015-01-01 01:13:01 2015-01-01 01:23:37
##  4 CJVYRASDZTXO674 CJVYRASDZTX… 2015-01-01 01:13:01 2015-01-01 01:24:37
##  5 CJVYRASDZTXO674 CJVYRASDZTX… 2015-01-01 01:13:01 2015-01-01 01:31:01
##  6 CJVYRASDZTXO674 CJVYRASDZTX… 2015-01-01 01:13:01 2015-01-01 01:31:43
##  7 CJVYRASDZTXO674 CJVYRASDZTX… 2015-01-01 01:13:01 2015-01-01 01:36:01
##  8 ECPANOIXLZHF896 ECPANOIXLZH… 2015-01-01 01:31:03 2015-01-01 01:31:27
##  9 ECPANOIXLZHF896 ECPANOIXLZH… 2015-01-01 01:31:03 2015-01-01 01:36:57
## 10 ECPANOIXLZHF896 ECPANOIXLZH… 2015-01-01 01:31:03 2015-01-01 01:37:45
## # … with more rows, and 7 more variables: item_type &lt;chr&gt;,
## #   item_name &lt;chr&gt;, item_revenue &lt;dbl&gt;, session_duration &lt;dbl&gt;,
## #   start_day &lt;date&gt;, acquisition &lt;chr&gt;, country &lt;chr&gt;</pre>
<p>And that's really it.
</p>



<h4>Obtaining remote database tables</h4>

<p>For remote databases, we have to specify quite a few things but it's a
one-step process nonetheless. Here's an example that accesses the <code>rna</code> table
(in the <em>RNA Central</em> public database) using <code>db_tbl()</code>. Here, for the <code>user</code>
and <code>password</code> entries we are using the literal username and password values
(publicly available when visiting the <em>RNA Central</em> website) by enclosing the
values in <code>I()</code>.
</p>
<div class="sourceCode r"><pre>rna_db_tbl &lt;- 
  db_tbl(
    table = "rna",
    dbtype = "postgres",
    dbname = "pfmegrnargs",
    host = "hh-pgsql-public.ebi.ac.uk",
    port = 5432,
    user = I("reader"),
    password = I("NWDMCE5xdipIjRrp")
  )

rna_db_tbl
</pre></div>
<pre>## # Source:   table&lt;rna&gt; [?? x 9]
## # Database: postgres
## #   [reader@hh-pgsql-public.ebi.ac.uk:5432/pfmegrnargs]
##          id upi    timestamp           userstamp crc64   len seq_short
##     &lt;int64&gt; &lt;chr&gt;  &lt;dttm&gt;              &lt;chr&gt;     &lt;chr&gt; &lt;int&gt; &lt;chr&gt;    
##  1 25222431 URS00… 2019-12-02 13:26:46 rnacen    E65C…   521 AGAGTTTG…
##  2 25222432 URS00… 2019-12-02 13:26:46 rnacen    6B91…   520 AGAGTTCG…
##  3 25222433 URS00… 2019-12-02 13:26:46 rnacen    03B8…   257 TACGTAGG…
##  4 25222434 URS00… 2019-12-02 13:26:46 rnacen    E925…   533 AGGGTTTG…
##  5 25222435 URS00… 2019-12-02 13:26:46 rnacen    C2D0…   504 GACGAACG…
##  6 25222436 URS00… 2019-12-02 13:26:46 rnacen    9EF6…   253 TACAGAGG…
##  7 25222437 URS00… 2019-12-02 13:26:46 rnacen    685A…   175 GAGGCAGC…
##  8 25222438 URS00… 2019-12-02 13:26:46 rnacen    4228…   556 AAAACATC…
##  9 25222439 URS00… 2019-12-02 13:26:46 rnacen    B7CC…   515 AGGGTTCG…
## 10 25222440 URS00… 2019-12-02 13:26:46 rnacen    038B…   406 ATTGAACG…
## # … with more rows, and 2 more variables: seq_long &lt;chr&gt;, md5 &lt;chr&gt;</pre>
<p>You'd normally want to use the names of environment variables (envvars) to
more securely access the appropriate username and password values when
connecting to a DB. Here are all the necessary inputs:
</p>
<div class="sourceCode r"><pre>example_db_tbl &lt;- 
  db_tbl(
    table = "&lt;table_name&gt;",
    dbtype = "&lt;database_type_shortname&gt;",
    dbname = "&lt;database_name&gt;",
    host = "&lt;connection_url&gt;",
    port = "&lt;connection_port&gt;",
    user = "&lt;DB_USER_NAME&gt;",
    password = "&lt;DB_PASSWORD&gt;"
  )
</pre></div>
<p>Environment variables can be created by editing the user <code>.Renviron</code> file and
the <code>usethis::edit_r_environ()</code> function makes this pretty easy to do.
</p>



<h4>DB table access and prep via the table store</h4>

<p>Using table-prep formulas in a centralized table store can make it easier to
work with DB tables in <strong>pointblank</strong>. Here's how to generate a table store
with two named entries for table preparations involving the <code>tbl_store()</code> and
<code>db_tbl()</code> functions.
</p>
<div class="sourceCode r"><pre>store &lt;-
  tbl_store(
    small_table_duck ~ db_tbl(
      table = pointblank::small_table,
      dbtype = "duckdb",
      dbname = ":memory:"
    ),
    small_high_duck ~ {{ small_table_duck }} %&gt;%
      dplyr::filter(f == "high")
  )
</pre></div>
<p>Now it's easy to obtain either of these tables via <code>tbl_get()</code>. We can
reference the table in the store by its name (given to the left of the <code>~</code>).
</p>
<div class="sourceCode r"><pre>tbl_get(tbl = "small_table_duck", store = store)
</pre></div>
<pre>## # Source:   table&lt;pointblank::small_table&gt; [?? x 8]
## # Database: duckdb_connection
##    date_time           date           a b           c      d e    
##    &lt;dttm&gt;              &lt;date&gt;     &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;lgl&gt;
##  1 2016-01-04 11:00:00 2016-01-04     2 1-bcd-…     3  3423. TRUE 
##  2 2016-01-04 00:32:00 2016-01-04     3 5-egh-…     8 10000. TRUE 
##  3 2016-01-05 13:32:00 2016-01-05     6 8-kdg-…     3  2343. TRUE 
##  4 2016-01-06 17:23:00 2016-01-06     2 5-jdo-…    NA  3892. FALSE
##  5 2016-01-09 12:36:00 2016-01-09     8 3-ldm-…     7   284. TRUE 
##  6 2016-01-11 06:15:00 2016-01-11     4 2-dhe-…     4  3291. TRUE 
##  7 2016-01-15 18:46:00 2016-01-15     7 1-knw-…     3   843. TRUE 
##  8 2016-01-17 11:27:00 2016-01-17     4 5-boe-…     2  1036. FALSE
##  9 2016-01-20 04:30:00 2016-01-20     3 5-bce-…     9   838. FALSE
## 10 2016-01-20 04:30:00 2016-01-20     3 5-bce-…     9   838. FALSE
## # … with more rows, and 1 more variable: f &lt;chr&gt;</pre>
<p>The second table in the table store is a mutated
version of the first. It's just as easily obtainable via <code>tbl_get()</code>:
</p>
<div class="sourceCode"><pre>tbl_get(tbl = "small_high_duck", store = store)
</pre></div>
<pre>## # Source:   lazy query [?? x 8]
## # Database: duckdb_connection
##   date_time           date           a b             c     d e    
##   &lt;dttm&gt;              &lt;date&gt;     &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;lgl&gt;
## 1 2016-01-04 11:00:00 2016-01-04     2 1-bcd-345     3 3423. TRUE 
## 2 2016-01-05 13:32:00 2016-01-05     6 8-kdg-938     3 2343. TRUE 
## 3 2016-01-15 18:46:00 2016-01-15     7 1-knw-093     3  843. TRUE 
## 4 2016-01-20 04:30:00 2016-01-20     3 5-bce-642     9  838. FALSE
## 5 2016-01-20 04:30:00 2016-01-20     3 5-bce-642     9  838. FALSE
## 6 2016-01-30 11:23:00 2016-01-30     1 3-dka-303    NA 2230. TRUE 
## # … with more rows, and 1 more variable: f &lt;chr&gt;</pre>
<p>The table-prep formulas in the <code>store</code> object could also be used in functions
with a <code>tbl</code> argument (like <code>create_agent()</code> and <code>create_informant()</code>). This
is accomplished most easily with the <code>tbl_source()</code> function.
</p>
<div class="sourceCode r"><pre>agent &lt;- 
  create_agent(
    tbl = ~ tbl_source(
      tbl = "small_table_duck",
      store = tbls
    )
  )
</pre></div>
<div class="sourceCode r"><pre>informant &lt;- 
  create_informant(
    tbl = ~ tbl_source(
      tbl = "small_high_duck",
      store = tbls
    )
  )
</pre></div>



<h3>Function ID</h3>

<p>1-6
</p>


<h3>See Also</h3>

<p>Other Planning and Prep: 
<code>action_levels()</code>,
<code>create_agent()</code>,
<code>create_informant()</code>,
<code>draft_validation()</code>,
<code>file_tbl()</code>,
<code>scan_data()</code>,
<code>tbl_get()</code>,
<code>tbl_source()</code>,
<code>tbl_store()</code>,
<code>validate_rmd()</code>
</p>


</div>