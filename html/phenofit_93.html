<div class="container">

<table style="width: 100%;"><tr>
<td>curvefits_LocalModel</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>curvefits by local model functions of TIMESAT</h2>

<h3>Description</h3>

<p>Local model functions <code>f_L(t)</code>, <code>f_C(t)</code> and <code>f_R(t)</code>
describe the VI variation in intervals around the left minima, the central
maxima and the right minima.
</p>
<p>Local model function are merged into global model function via <code>merge_LocalModels()</code>
and Per J\"onsson et al. (2004; their Eq. 12),
where cut-off function sharply drop from 1 to 0 in small intervals around
<code>(t_L + t_C)/2</code> and <code>(t_C + t_R)/2</code>.
</p>
<p style="text-align: center;"><code class="reqn">
F(t)= \begin{cases}
\alpha(t) f_{L}(t)+[1-\alpha(t)] f_{C}(t), t_{L}&lt;t&lt;t_{C} \\ 
\beta(t) f_{C}(t)+[1-\beta(t)] f_{R}(t), t_{C}&lt;t&lt;t_{R}\end{cases}
</code>
</p>



<h3>Usage</h3>

<pre><code class="language-R">curvefits_LocalModel(INPUT, brks, options = list(), ...)

merge_LocalModels(fits)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>INPUT</code></td>
<td>
<p>A list object with the elements of 't', 'y', 'w', 'Tn' (optional)
and 'ylu', returned by <code>check_input</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>brks</code></td>
<td>
<p>A list object with the elements of 'fit' and 'dt', returned by
<code>season</code> or <code>season_mov</code>, which contains the growing season division information.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>options</code></td>
<td>
<p>see section: options for fitting for details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>other parameters to <code>curvefit()</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>fits</code></td>
<td>
<p>List objects returned by <code>curvefits_LocalModel()</code> (not <code>curvefits()</code>).</p>
</td>
</tr>
</table>
<h3>options for fitting</h3>


<ul>
<li> <p><code>methods</code> (default <code style="white-space: pre;">⁠c('AG', 'Beck', 'Elmore', 'Zhang')``): Fine curve fitting methods, can be one or more of ⁠</code>c('AG', 'Beck', 'Elmore', 'Zhang',
'Gu', 'Klos')‘. Note that ’Gu' and 'Klos' are very slow.
</p>
</li>
<li> <p><code>iters</code> (default 2): max iterations of fine fitting.
</p>
</li>
<li> <p><code>wFUN</code> (default <code>wTSM</code>): Character or function, weights updating function
of fine fitting function.
</p>
</li>
<li> <p><code>wmin</code> (default 0.1): min weights in the weights updating procedure.
</p>
</li>
<li> <p><code>use.rough</code> (default FALSE): Whether to use rough fitting smoothed
time-series as input? If <code>false</code>, smoothed VI by rough fitting will be used
for Phenological metrics extraction; If <code>true</code>, original input <code>y</code> will be
used (rough fitting is used to divide growing seasons and update weights.
</p>
</li>
<li> <p><code>use.y0</code> (default TRUE): boolean. whether to use original <code>y0</code> as the input
of <code>plot_input</code>, note that not for curve fitting. <code>y0</code> is the original
value before the process of <code>check_input</code>.
</p>
</li>
<li> <p><code>nextend</code> (default 2): Extend curve fitting window, until <code>nextend</code> good or
marginal points are found in the previous and subsequent growing season.
</p>
</li>
<li> <p><code>maxExtendMonth</code> (default 1): Search good or marginal good values in
previous and subsequent <code>maxExtendMonth</code> period.
</p>
</li>
<li> <p><code>minExtendMonth</code> (default 0.5): Extend period defined by <code>nextend</code> and
<code>maxExtendMonth</code>, should be no shorter than <code>minExtendMonth</code>. When all
points of the input time-series are good value, then the extending period
will be too short. In that situation, we can't make sure the connection
between different growing seasons is smoothing.
</p>
</li>
<li> <p><code>minPercValid</code>: (default 0, not use). If the percentage of good- and
marginal- quality points is less than <code>minPercValid</code>, curve fiting result is
set to <code>NA</code>.
</p>
</li>
<li> <p><code>minT</code>: (not use). If <code>Tn</code> not provided in <code>INPUT</code>, <code>minT</code> will
not be used. <code>minT</code> use night temperature Tn to define backgroud value
(days with <code>Tn &lt; minT</code> treated as ungrowing season).
</p>
</li>
</ul>
<h3>References</h3>


<ol><li>
<p> Per J\"onsson, P., Eklundh, L., 2004. TIMESAT - A program for analyzing
time-series of satellite sensor data. Comput. Geosci. 30, 833-845.
<a href="https://doi.org/10.1016/j.cageo.2004.05.006">doi:10.1016/j.cageo.2004.05.006</a>.
</p>
</li></ol>
<h3>See Also</h3>

<p><code>curvefits()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
library(phenofit)

data("CA_NS6")
d = CA_NS6

nptperyear &lt;- 23
INPUT &lt;- check_input(d$t, d$y, d$w, QC_flag = d$QC_flag,
     nptperyear = nptperyear, south = FALSE,
     maxgap = nptperyear/4, alpha = 0.02, wmin = 0.2)
# plot_input(INPUT)

# Rough fitting and growing season dividing
wFUN &lt;- "wTSM"
brks2 &lt;- season_mov(INPUT,
    options = list(
        rFUN = "smooth_wWHIT", wFUN = wFUN,
        r_min = 0.05, ypeak_min = 0.05,
        lambda = 10,
        verbose = FALSE
    ))
# plot_season(INPUT, brks2, d)

# Fine fitting
fits &lt;- curvefits_LocalModel(
    INPUT, brks2,
    options = list(
        methods = c("AG", "Beck", "Elmore", "Zhang", "Gu"), #,"klos", "Gu"
        wFUN = wFUN,
        nextend = 2, maxExtendMonth = 2, minExtendMonth = 1, minPercValid = 0.2
    ),
    constrain = TRUE
)
# merge local model function into global model function
fits_merged = merge_LocalModels(fits) 

## Visualization ---------------------------------------------------------------
l_fitting = map(fits %&gt;% guess_names, get_fitting) #%&gt;% melt_list("period")

d_merged = get_fitting(fits_merged[[2]]) %&gt;% cbind(type = "Merged")
d_raw = l_fitting[2:4] %&gt;% set_names(c("Left", "Central", "Right")) %&gt;%
    melt_list("type")
d_obs = d_raw[, .(t, y, QC_flag)] %&gt;% unique()
d_fit = rbind(d_merged, d_raw)[meth == "Zhang"]

levs = c("Left", "Central", "Right", "Merged")
levs_new = glue("({letters[1:4]}) {levs}") %&gt;% as.character()
d_fit$type %&lt;&gt;% factor(levs, levs_new)

p = ggplot(d_obs, aes(t, y)) +
    geom_point() +
    geom_line(data = d_fit, aes(t, ziter2, color = type)) +
    facet_wrap(~type) +
    labs(x = "Date", y = "EVI") +
    scale_x_date(date_labels = "%b %Y", expand = c(1, 1)*0.08) +
    theme_bw(base_size = 13) +
    theme(legend.position = "none",
          strip.text = element_text(size = 14))
p

## End(Not run)
</code></pre>


</div>