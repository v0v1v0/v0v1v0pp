<div class="container">

<table style="width: 100%;"><tr>
<td>make.simmap</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Simulate stochastic character maps on a phylogenetic tree or trees</h2>

<h3>Description</h3>

<p>Performs stochastic character mapping (Huelsenbeck et al., 2003) using several different alternative methods.
</p>


<h3>Usage</h3>

<pre><code class="language-R">make.simmap(tree, x, model="SYM", nsim=1, ...)
simmap(object, ...)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>tree</code></td>
<td>
<p>a phylogenetic tree as an object of class <code>"phylo"</code>, or a list of trees as an object of class <code>"multiPhylo"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>a vector containing the tip states for a discretely valued character, or a matrix containing the prior probabilities of tip states in rows and character states as column names. The names (if <code>x</code> is a vector) or row names (if <code>x</code> is a matrix) should match the tip labels of the tree. The vector can be of class <code>"factor"</code>, <code>"character"</code>, or <code>"numeric"</code> (although in the lattermost case its content should obviously be only integer values).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model</code></td>
<td>
<p>a character string containing the model or a transition model specified in the form of a matrix. See <code>ace</code> for more details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nsim</code></td>
<td>
<p>number of simulations. If <code>tree</code> is an object of class <code>"multiPhylo"</code>, then <code>nsim</code> simulations will be conducted <em>per</em> input tree.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>optional arguments. So far, <code>pi</code> gives the prior distribution on the root node of the tree. Acceptable values for <code>pi</code> are <code>"equal"</code>, <code>"estimated"</code>, or a vector with the frequencies. If <code>pi="estimated"</code> then the stationary distribution is estimated by numerically solving <code>pi*Q=0</code> for <code>pi</code>, and this is used as a prior on the root. If <code>pi="fitzjohn"</code>, then the Fitzjohn et al. (2009) root prior is used. Finally, if <code>pi</code> is a numeric vector then the root state will be sampled from this vector. The function defaults to <code>pi="equal"</code> which results in the root node being sampled from the conditional scaled likelihood distribution at the root. <code>message</code> tells whether or not to print a message containing the rate matrix, <em>Q</em> and state frequencies. <code>message</code> defaults to <code>TRUE</code>. For optional argument <code>Q="mcmc"</code> (see below) the mean value of <code>Q</code> from the posterior sample is printed. <code>tol</code> gives the tolerance for zero elements in <code>Q</code>. (Elements less then <code>tol</code> will be reset to <code>tol</code>). Optional argument <code>Q</code> can be a string (<code>"empirical"</code> or <code>"mcmc"</code>), or a fixed value of the transition matrix, <em>Q</em>. If <code>"empirical"</code> than a single value of <em>Q</em>, the most likely value, is used for all simulations. If <code>"mcmc"</code>, then <code>nsim</code> values of <em>Q</em> are first obtained from the posterior distribution for <em>Q</em> using Bayesian MCMC, then a simulated stochastic character map is generated for each sampled value of <em>Q</em>. Optional argument <code>vQ</code> can consist of a single numeric value or a vector containing the variances of the (normal) proposal distributions for the MCMC. The order of <code>vQ</code> is assumed to be in the order of the <code>index.matrix</code> in <code>ace</code> for the chosen model. <code>prior</code> is a list containing <code>alpha</code> and <code>beta</code> parameters for the <code class="reqn">\Gamma</code> prior distribution on the transition rates in <em>Q</em>. Note that <code>alpha</code> and <code>beta</code> can be single values or vectors, if different priors are desired for each value in the transition matrix <em>Q</em>. As for <code>vQ</code>, the order of <code>prior</code> is assumed to correspond with the order of <code>index.matrix</code> as in <code>ace</code>. <code>prior</code> can also be given the optional logical value <code>use.empirical</code> which tells the function whether or not to give the prior distribution the empirical mean for <em>Q</em>. If <code>TRUE</code> then only <code>prior$beta</code> is used and <code>prior$alpha</code> is set equal to <code>prior$beta</code> times the empirical mean of <em>Q</em>. <code>burnin</code> and <code>samplefreq</code> are burn-in and sample frequency for the MCMC, respectively.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>object</code></td>
<td>
<p>for generic <code>simmap</code> method, object of various classes: for instance, an object of class <code>"fitMk"</code> from <code>fitMk</code>.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>For <code>Q="empirical"</code>, <code>make.simmap</code> first fits a continuous-time reversible Markov model for the evolution of <code>x</code> and then simulates stochastic character histories using that model and the tip states on the tree. This is the same procedure that is described in Bollback (2006), except that simulation is performed using a fixed value of the transition matrix, <em>Q</em>, instead of by sampling <em>Q</em> from its posterior distribution.
</p>
<p>For <code>Q="mcmc"</code>, <code>make.simmap</code> first samples <em>Q</em> <code>nsim</code> times from the posterior probability distribution of <em>Q</em> using MCMC, then it simulates <code>nsim</code> stochastic maps conditioned on each sampled value of <em>Q</em>.
</p>
<p>For <code>Q</code> set to a matrix, <code>make.simmap</code> samples stochastic mappings conditioned on the fixed input matrix.
</p>
<p><code>make.simmap</code> uses code that has been adapted from <span class="pkg">ape</span>'s function <code>ace</code> (by Paradis et al.) to perform Felsenstein's pruning algorithm to compute the likelihood.
</p>
<p>As of <span class="pkg">phytools</span> &gt;= 0.2-33 <code>x</code> can be a vector of states or a matrix containing the prior probabilities of tip states in rows. In this case the column names of <code>x</code> should contain the states, and the row names should contain the tip names.
</p>
<p>Note that there was a small (but potentially significant) bug in how node states were simulated by <code>make.simmap</code> in versions of <span class="pkg">phytools</span> &lt;= 0.2-26. Between <span class="pkg">phytools</span> 0.2-26 and 0.2-36 there was also a bug for asymmetric models of character change (e.g., <code>model="ARD"</code>). Finally, between <span class="pkg">phytools</span> 0.2-33 and <span class="pkg">phytools</span> 0.2-47 there was an error in use of the conditional likelihoods for the root node, which caused the root node of the tree to be sampled incorrectly. Giorgio Bianchini pointed out that in <span class="pkg">phytools</span> 1.0-1 (and probably prior recent versions) there was an error sampling the state at the root node of the tree based on the input prior (<code>pi</code>) supplied by a user â€“ except for <code>pi="equal"</code> (a flat prior, the default) or for a prior distribution in which one or another state was known to be the global root state (e.g., <code>pi=c(1,0)</code>, <code>pi=c(0,1)</code>, etc.). All of these issues should be fixed in the current and all later versions.
</p>
<p>If <code>tree</code> is an object of class <code>"multiPhylo"</code> then <code>nsim</code> stochastic maps are generated for each input tree.
</p>


<h3>Value</h3>

<p>A object of class <code>"simmap"</code> or <code>"multiSimmap"</code> which consists of an object of class <code>"phylo"</code> (or a list of such objects with class <code>"multiPhylo"</code>), with the following additional elements:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>maps</code></td>
<td>
<p>a list of named vectors containing the times spent in each state on each branch, in the order in which they occur.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>mapped.edge</code></td>
<td>
<p>a matrix containing the total time spent in each state along each edge of the tree.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>Q</code></td>
<td>
<p>the assumed or sampled value of <code>Q</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>logL</code></td>
<td>
<p>the log-likelihood of the assumed or sampled <code>Q</code>.</p>
</td>
</tr>
</table>
<h3>Author(s)</h3>

<p>Liam Revell <a href="mailto:liam.revell@umb.edu">liam.revell@umb.edu</a></p>


<h3>References</h3>

<p>Bollback, J. P. (2006) Stochastic character mapping of discrete traits on phylogenies. <em>BMC Bioinformatics</em>, <b>7</b>, 88.
</p>
<p>FitzJohn, R. G., W. P. Maddison, and S. P. Otto (2009) Estimating trait-dependent speciation and extinction rates from incompletely resolved phylogenies. <em>Systematic Biology</em>, <b>58</b>, 595-611.
</p>
<p>Huelsenbeck, J. P., R. Neilsen, and J. P. Bollback (2003) Stochastic mapping of morphological characters. <em>Systematic Biology</em>, <b>52</b>, 131-138. 
</p>
<p>Paradis, E., J. Claude, and K. Strimmer (2004) APE: Analyses of phylogenetics and evolution in R language. <em>Bioinformatics</em>, <b>20</b>, 289-290.
</p>
<p>Revell, L. J. (2024) phytools 2.0: an updated R ecosystem for phylogenetic comparative methods (and other things). <em>PeerJ</em>, <b>12</b>, e16505.
</p>
<p>Revell, L. J. and L. J. Harmon (2022) <em>Phylogenetic Comparative Methods in R</em>. Princeton University Press.
</p>


<h3>See Also</h3>

<p><code>brownie.lite</code>, <code>brownieREML</code>, <code>countSimmap</code>, <code>describe.simmap</code>, <code>evol.vcv</code>, <code>plotSimmap</code>, <code>read.simmap</code>, <code>write.simmap</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Not run: 
## load tree and data from Revell &amp; Collar (2009)
data(sunfish.tree)
data(sunfish.data)
## extract discrete character (feeding mode)
fmode&lt;-setNames(sunfish.data$feeding.mode,
  rownames(sunfish.data))
## fit model
er_model&lt;-fitMk(sunfish.tree,fmode,model="ER",
  pi="fitzjohn")
## do stochastic mapping
sunfish_smap&lt;-simmap(er_model)
## print a summary of the stochastic mapping
summary(sunfish_smap)
## plot a posterior probabilities of ancestral states
cols&lt;-setNames(c("blue","red"),levels(fmode))
plot(summary(sunfish_smap),colors=cols,ftype="i")
legend("topleft",c("non-piscivorous","piscivorous"),
  pch=21,pt.bg=cols,pt.cex=2)
par(mar=c(5.1,4.1,4.1,2.1),las=1)
## plot posterior density on the number of changes
plot(density(sunfish_smap),bty="l")
title(main="Posterior distribution of changes of each type",
  font.main=3)
## End(Not run)
</code></pre>


</div>