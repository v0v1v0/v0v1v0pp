<div class="container">

<table style="width: 100%;"><tr>
<td>spat.corr.diagnostic</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Diagnostics for residual spatial correlation</h2>

<h3>Description</h3>

<p>This function performs two variogram-based tests for residual spatial correlation in real-valued and count (Binomial and Poisson) data.
</p>


<h3>Usage</h3>

<pre><code class="language-R">spat.corr.diagnostic(
  formula,
  units.m = NULL,
  coords,
  data,
  likelihood,
  ID.coords = NULL,
  n.sim = 200,
  nAGQ = 1,
  uvec = NULL,
  plot.results = TRUE,
  lse.variogram = FALSE,
  kappa = 0.5,
  which.test = "both"
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>
<p>an object of class <code>formula</code> (or one that can be coerced to that class): a symbolic description of the model to be fitted.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>units.m</code></td>
<td>
<p>vector of binomial denominators, or offset if the Poisson model is used.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>coords</code></td>
<td>
<p>an object of class <code>formula</code> indicating the geographic coordinates.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>an object of class "data.frame" containing the data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>likelihood</code></td>
<td>
<p>a character that can be set to "Gaussian","Binomial" or "Poisson"</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ID.coords</code></td>
<td>
<p>vector of ID values for the unique set of spatial coordinates obtained from <code>create.ID.coords</code>.
These must be provided if, for example, spatial random effects are defined at
household level but some of the covariates are at individual level. <b>Warning</b>: the household coordinates must all be distinct
otherwise see <code>jitterDupCoords</code>. Default is <code>NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n.sim</code></td>
<td>
<p>number of simulations used to perform the selected test(s) for spatial correlation.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nAGQ</code></td>
<td>
<p>integer scalar (passed to <code>glmer</code>) - the number of points per axis for evaluating the adaptive Gauss-Hermite approximation to the log-likelihood.
Defaults to 1, corresponding to the Laplace approximation. Values greater than 1 produce greater accuracy in the evaluation of the
log-likelihood at the expense of speed. A value of zero uses a faster but less exact form of parameter estimation for GLMMs by optimizing
the random effects and the fixed-effects coefficients in the penalized iteratively reweighted least squares step.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>uvec</code></td>
<td>
<p>a vector with values used to define the variogram binning. If <code>uvec=NULL</code>, then <code>uvec</code> is then set to <code>seq(MIN_DIST,(MAX_DIST-MIN_DIST)/2,length=15)</code>
where <code>MIN_DIST</code> and <code>MAX_DIST</code> are the minimum and maximum observed distances.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>plot.results</code></td>
<td>
<p>if <code>plot.results=TRUE</code>, a plot is returned showing the results for the selected test(s) for spatial correlation. By default <code>plot.results=TRUE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>lse.variogram</code></td>
<td>
<p>if <code>lse.variogram=TRUE</code>, a weighted least square fit of a Matern function (with fixed <code>kappa</code>) to the empirical variogram is performed. If <code>plot.results=TRUE</code> and <code>lse.variogram=TRUE</code>, the
fitted weighted least square fit is displayed as a dashed line in the returned plot.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>kappa</code></td>
<td>
<p>smothness parameter of the Matern function for the Gaussian process to approximate. The deafault is <code>kappa=0.5</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>which.test</code></td>
<td>
<p>a character specifying which test for residual spatial correlation is to be performed: "variogram", "test statistic" or "both". The default is <code>which.test="both"</code>. See 'Details'.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>The function first fits a generalized linear mixed model using the for an outcome <code class="reqn">Y_i</code> which, conditionally on i.i.d. random effects <code class="reqn">Z_i</code>, are mutually independent
GLMs with linear predictor
</p>
<p style="text-align: center;"><code class="reqn">g^{-1}(\eta_i)=d_i'\beta+Z_i</code>
</p>

<p>where <code class="reqn">d_i</code> is a vector of covariates which are specified through <code>formula</code>. Finally, the <code class="reqn">Z_i</code> are assumed to be zero-mean Gaussian variables with variance <code class="reqn">\sigma^2</code>
</p>
<p><b>Variogram-based graphical diagnostic</b>
</p>
<p>This graphical diagnostic is performed by setting <code>which.test="both"</code> or <code>which.test="variogram"</code>. The output are 95
(see below <code>lower.lim</code> and <code>upper.lim</code>) that are generated under the assumption of spatial indepdence through the following steps
</p>
<p>1. Fit a generalized linear mixed model as indicated by the equation above.
</p>
<p>2. Obtain the mode, say <code class="reqn">\hat{Z}_i</code>, of the <code class="reqn">Z_i</code> conditioned on the data <code class="reqn">Y_i</code>.
</p>
<p>3. Compute the empirical variogram using <code class="reqn">\hat{Z}_i</code>
</p>
<p>4. Permute the locations specified in <code>coords</code>, <code>n.sim</code> time while holding the <code class="reqn">\hat{Z}_i</code> fixed.
</p>
<p>5. For each of the permuted data-sets compute the empirical variogram based on the <code class="reqn">\hat{Z}_i</code>.
</p>
<p>6. From the <code>n.sim</code> variograms obtained in the previous step, compute the 95
</p>
<p>If the observed variogram (<code>obs.variogram</code> below), based on the un-permuted <code class="reqn">\hat{Z}_i</code>, falls within the 95
residual spatial correlation; if, instead, that partly falls outside the 95
</p>
<p><b>Test for spatial independence</b>
</p>
<p>This diagnostic test is performed if <code>which.test="both"</code> or <code>which.test="test statistic"</code>. Let <code class="reqn">\hat{v}(B)</code> denote the empirical variogram based on <code class="reqn">\hat{Z}_i</code> for the distance bin <code class="reqn">B</code>.
The test statistic used for testing residual spatial correlation is
</p>
<p style="text-align: center;"><code class="reqn">T = \sum_{B} N(B) \{v(B)-\hat{\sigma}^2\}</code>
</p>

<p>where <code class="reqn">N(B)</code> is the number of pairs of data-points falling within the distance bin <code class="reqn">B</code> (<code>n.bins</code> below) and <code class="reqn">\hat{\sigma}^2</code> is the estimate of <code class="reqn">\sigma^2</code>.
</p>
<p>To obtain the distribution of the test statistic <code class="reqn">T</code> under the null hypothesis of spatial independence, we use the simulated empirical variograms as obtained in step 5 of the iterative procedure described in "Variogram-based graphical diagnostic."
The p-value for the test of spatial independence is then computed by taking the proportion of simulated values for <code class="reqn">T</code> under the null the hypothesis that are larger than the value of <code class="reqn">T</code> based on the original (un-permuted) <code class="reqn">\hat{Z}_i</code>
</p>


<h3>Value</h3>

<p>An object of class "PrevMap.diagnostic" which is a list containing the following components:
</p>
<p><code>obs.variogram</code>: a vector of length <code>length(uvec)-1</code> containing the values of the variogram for each of
the distance bins defined through <code>uvec</code>.
</p>
<p><code>distance.bins</code>: a vector of length <code>length(uvec)-1</code> containing the average distance within each of the distance bins
defined through <code>uvec</code>.
</p>
<p><code>n.bins</code>: a vector of length <code>length(uvec)-1</code> containing the number of pairs of data-points falling within each distance bin.
</p>
<p><code>lower.lim</code>: (available only if <code>which.test="both"</code> or <code>which.test="variogram"</code>) a vector of length <code>length(uvec)-1</code> containing the lower limits of the 95
generated under the assumption of absence of spatial correlation at each fo the distance bins  defined through <code>uvec</code>.
</p>
<p><code>upper.lim</code>: (available only if <code>which.test="both"</code> or <code>which.test="variogram"</code>) a vector of length <code>length(uvec)-1</code> containing the upper limits of the 95
generated under the assumption of absence of spatial correlation at each fo the distance bins  defined through <code>uvec</code>.
</p>
<p><code>mode.rand.effects</code>: the predictive mode of the random effects from the fitted non-spatial generalized linear mixed model.
</p>
<p><code>p.value</code>: (available only if <code>which.test="both"</code> or <code>which.test="test statistic"</code>) p-value of the test for residual spatial correlation.
</p>
<p><code>lse.variogram</code>: (available only if <code>lse.variogram=TRUE</code>) a vector of length <code>length(uvec)-1</code> containing the values of the estimated Matern variogram via a weighted least square fit.
</p>


</div>