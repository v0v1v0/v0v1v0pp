<div class="container">

<table style="width: 100%;"><tr>
<td>pspl_terms</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Functions to include non-parametric continous covariates 
and spatial or spatio-temporal trends in semiparametric
regression models.</h2>

<h3>Description</h3>

<p>The <code>pspl()</code> and <code>pspt()</code> functions 
allow the inclusion of non-parametric continuous covariates
and spatial or spatio-temporal trends in semiparametric 
regression models. Both type of terms are modelled using P-splines.
</p>
<p><code>pspl()</code>: This function allows the inclusion of terms for
non-parametric covariates in semiparametric models. 
Each non-parametric covariate must be included with its own <code>pspl</code> 
term in a formula.
</p>
<p><code>pspt()</code>: This function allows the inclusion of a spatial or
spatio-temporal trend in the formula of the
semiparametric spatial or spatio-temporal models. 
The trend can be decomposed in an ANOVA
functional way including main and interaction effects.
</p>


<h3>Usage</h3>

<pre><code class="language-R">pspl(
  x,
  xl = min(x) - 0.01 * abs(min(x)),
  xr = max(x) + 0.01 * abs(max(x)),
  nknots = 10,
  bdeg = 3,
  pord = 2,
  decom = 2,
  scale = TRUE
)

pspt(
  sp1,
  sp2,
  time = NULL,
  scale = TRUE,
  ntime = NULL,
  xl_sp1 = min(sp1) - 0.01 * abs(min(sp1)),
  xr_sp1 = max(sp1) + 0.01 * abs(max(sp1)),
  xl_sp2 = min(sp2) - 0.01 * abs(min(sp2)),
  xr_sp2 = max(sp2) + 0.01 * abs(max(sp2)),
  xl_time = min(time) - 0.01 * abs(min(time)),
  xr_time = max(time) + 0.01 * abs(max(time)),
  nknots = c(10, 10, 5),
  bdeg = c(3, 3, 3),
  pord = c(2, 2, 2),
  decom = 2,
  psanova = FALSE,
  nest_sp1 = 1,
  nest_sp2 = 1,
  nest_time = 1,
  f1_main = TRUE,
  f2_main = TRUE,
  ft_main = TRUE,
  f12_int = TRUE,
  f1t_int = TRUE,
  f2t_int = TRUE,
  f12t_int = TRUE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>Name of the covariate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xl</code></td>
<td>
<p>Minimum of the interval for the continuous covariate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xr</code></td>
<td>
<p>Maximum of the interval for the continuous covariate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nknots</code></td>
<td>
<p>Vector including the number of knots of each 
coordinate for spline bases. Default = c(10,10,5). The order of the knots
in the vector follows the order of the specified spatio-temporal parameters 
so the first value of the vector is the number of knots for <code>sp1</code>, the second
value is for <code>sp2</code> and the third for <code>time</code>. See <code>Examples</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bdeg</code></td>
<td>
<p>Order of the B-spline bases. Default = c(3,3,3).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pord</code></td>
<td>
<p>Order of the penalty for the difference matrices 
in P-spline. Default = c(2,2,2).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>decom</code></td>
<td>
<p>Type of decomposition of fixed part when P-spline
term is expressed as a mixed model. If <code>decom = 1</code> the 
fixed part is given by <code class="reqn">X = B*U_n</code> where <em>B</em> is the
B-spline basis matrix and <em>U_n</em> is the nullspace basis of the 
penalty matrix. If <code>decom = 2</code> the fixed part is given by
<code class="reqn">X = [1|x|...|x^(pord-1)] </code>. Default = 2.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>scale</code></td>
<td>
<p>Logical value to scale the spatial and temporal 
coordinates before the estimation of semiparametric model. 
Default = 'TRUE'</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sp1</code></td>
<td>
<p>Name of the first spatial coordinate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sp2</code></td>
<td>
<p>Name of the second spatial coordinate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>time</code></td>
<td>
<p>Name of the temporal coordinate. It must be 
specified only for spatio-temporal trends when using panel data. 
Default = 'NULL'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ntime</code></td>
<td>
<p>Number of temporal periods in panel data.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xl_sp1</code></td>
<td>
<p>Minimum of the interval for the first spatial coordinate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xr_sp1</code></td>
<td>
<p>Maximum of the interval for the first spatial coordinate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xl_sp2</code></td>
<td>
<p>Minimum of the interval for the second spatial coordinate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xr_sp2</code></td>
<td>
<p>Maximum of the interval for the second spatial coordinate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xl_time</code></td>
<td>
<p>Minimum of the interval for the temporal coordinate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xr_time</code></td>
<td>
<p>Maximum of the interval for the temporal coordinate.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>psanova</code></td>
<td>
<p>Logical value to choose an ANOVA decomposition
of the spatial or spatio-temporal trend. Default = 'FALSE'.
If 'TRUE', you must specify the divisors for
main, and interaction effects. More in <code>Examples</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nest_sp1</code></td>
<td>
<p>Vector including the divisor of the knots for main 
and interaction effects for the first spatial coordinate. It
is used for ANOVA decomposition models including nested bases.
Default = 1 (no nested bases). The values must be divisors and the resulting
value of the division should not be smaller than 4.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nest_sp2</code></td>
<td>
<p>Vector including the divisor of the knots for main 
and interaction effects for the second spatial coordinate. It
is used for ANOVA decomposition models including nested bases.
Default = 1 (no nested bases). The values must be divisors and the resulting
value of the division should not be smaller than 4.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nest_time</code></td>
<td>
<p>Vector including the divisor of the knots for main 
and interaction effects for the temporal coordinate. It
is used for ANOVA decomposition models including nested bases.
Default = 1 (no nested bases). The values must be divisors and the resulting
value of the division should not be smaller than 4.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>f1_main</code></td>
<td>
<p>Logical value to include main effect for the first spatial
coordinate in ANOVA models. Default = 'TRUE'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>f2_main</code></td>
<td>
<p>Logical value to include main effect for the second spatial
coordinate in ANOVA models. Default = 'TRUE'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ft_main</code></td>
<td>
<p>Logical value to include main effect for the temporal
coordinate in ANOVA models. Default = 'TRUE'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>f12_int</code></td>
<td>
<p>Logical value to include second-order interaction effect 
between first and second spatial coordinates in ANOVA models. 
Default = 'TRUE'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>f1t_int</code></td>
<td>
<p>Logical value to include second-order interaction effect 
between first spatial and temporal coordinates in ANOVA 
models. Default = 'TRUE'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>f2t_int</code></td>
<td>
<p>Logical value to include second-order interaction effect 
between second spatial and temporal coordinates in ANOVA 
models. Default = 'TRUE'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>f12t_int</code></td>
<td>
<p>Logical value to include third-order interaction effect 
between first and second spatial coordinates and temporal 
coordinates in ANOVA models. Default = 'TRUE'.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p><code>pspl()</code>: An object of class <em>bs</em> including.
</p>

<table>
<tr>
<td style="text-align: left;">
    <code>B</code> </td>
<td style="text-align: left;"> Matrix including B-spline basis for the covariate </td>
</tr>
<tr>
<td style="text-align: left;">
    <code>a</code> </td>
<td style="text-align: left;"> List including <em>nknots</em>, <em>knots</em>, <em>bdeg</em>,
        <em>pord</em> and <em>decom</em>.  </td>
</tr>
<tr>
<td style="text-align: left;">
 </td>
</tr>
</table>
<p><code>pspt()</code>: An object of class <em>bs</em> including.
</p>

<table>
<tr>
<td style="text-align: left;">
     <code>B</code> </td>
<td style="text-align: left;"> Matrix including B-spline basis for the covariate </td>
</tr>
<tr>
<td style="text-align: left;">
     <code>a</code> </td>
<td style="text-align: left;"> List including <em>sp1</em>, <em>sp2</em>, <em>time</em>,
       <em>nknots</em>, <em>bdeg</em>, <em>pord</em>, <em>decom</em>,
       <em>psanova</em>, <em>nest_sp1</em>, <em>nest_sp2</em>,
       <em>nest_time</em>, <em>f1_main</em>, <em>f2_main</em>, <em>ft_main</em>,
       <em>f12_int</em>, <em>f1t_int</em>, <em>f2t_int</em>, and 
       <em>f12t_int</em>. </td>
</tr>
<tr>
<td style="text-align: left;"> 
   </td>
</tr>
</table>
<h3>References</h3>

 
<ul>
<li>
<p> Eilers, P. and Marx, B. (1996). Flexible Smoothing with 
B-Splines and Penalties. <em>Statistical Science</em>, (11), 89-121.
</p>
</li>
<li>
<p> Eilers, P. and Marx, B. (2021). <em>Practical Smoothing. 
The Joys of P-Splines</em>. Cambridge University Press.
</p>
</li>
<li>
<p> Fahrmeir, L.; Kneib, T.;  Lang, S.; and Marx, B. (2021). 
<em>Regression. Models, Methods and Applications (2nd Ed.)</em>.
Springer.
</p>
</li>
<li>
<p> Lee, D. and Durban, M. (2011). P-Spline ANOVA Type Interaction 
Models for Spatio-Temporal Smoothing. <em>Statistical Modelling</em>, 
(11), 49-69. &lt;doi:10.1177/1471082X1001100104&gt;
</p>
</li>
<li>
<p> Lee, D. J., Durban, M., and Eilers, P. (2013). Efficient
two-dimensional smoothing with P-spline ANOVA mixed models 
and nested bases. <em>Computational Statistics &amp; Data Analysis</em>, 
(61), 22-37. &lt;doi:10.1016/j.csda.2012.11.013&gt;
</p>
</li>
<li>
<p> Minguez, R.; Basile, R. and Durban, M. (2020). An Alternative 
Semiparametric Model for Spatial Panel Data. <em>Statistical Methods and Applications</em>,
(29), 669-708. &lt;doi:	10.1007/s10260-019-00492-8&gt;
</p>
</li>
<li>
<p> Wood, S.N. (2017). <em>Generalized Additive Models. 
An Introduction with <code>R</code></em> (second edition). CRC Press, Boca Raton.
</p>
</li>
</ul>
<h3>See Also</h3>

<p><code>pspatfit</code> estimate semiparametric spatial or
spatio-temporal regression models.
</p>


<h3>Examples</h3>

<pre><code class="language-R">library(pspatreg)
###############################################
# Examples using spatial data of Ames Houses.
###############################################
library(spdep)
library(sf)
ames &lt;- AmesHousing::make_ames() # Raw Ames Housing Data
ames_sf &lt;- st_as_sf(ames, coords = c("Longitude", "Latitude"))
ames_sf$Longitude &lt;- ames$Longitude
ames_sf$Latitude &lt;- ames$Latitude
ames_sf$lnSale_Price &lt;- log(ames_sf$Sale_Price)
ames_sf$lnLot_Area &lt;- log(ames_sf$Lot_Area)
ames_sf$lnTotal_Bsmt_SF &lt;- log(ames_sf$Total_Bsmt_SF+1)
ames_sf$lnGr_Liv_Area &lt;- log(ames_sf$Gr_Liv_Area)
ames_sf1 &lt;- ames_sf[(duplicated(ames_sf$Longitude) == FALSE), ]
####  GAM pure with pspatreg
form1 &lt;- lnSale_Price ~ Fireplaces + Garage_Cars +
          pspl(lnLot_Area, nknots = 20) + 
          pspl(lnTotal_Bsmt_SF, nknots = 20) +
          pspl(lnGr_Liv_Area, nknots = 20)    
gampure &lt;- pspatfit(form1, data = ames_sf1)
summary(gampure)
 
########### Constructing the spatial weights matrix
coord_sf1 &lt;- cbind(ames_sf1$Longitude, ames_sf1$Latitude)
k5nb &lt;- knn2nb(knearneigh(coord_sf1, k = 5, 
                          longlat = TRUE, use_kd_tree = FALSE), sym = TRUE)
lw_ames &lt;- nb2listw(k5nb, style = "W", 
                  zero.policy = FALSE)
#####################  GAM + SAR Model
gamsar &lt;- pspatfit(form1, data = ames_sf1, 
                   type = "sar", listw = lw_ames,
                   method = "Chebyshev")
summary(gamsar)
### Models with 2d spatial trend
form2 &lt;- lnSale_Price ~ Fireplaces + Garage_Cars +
          pspl(lnLot_Area, nknots = 20) + 
          pspl(lnTotal_Bsmt_SF, nknots = 20) +
          pspl(lnGr_Liv_Area, nknots = 20) +
          pspt(Longitude, Latitude, 
               nknots = c(10, 10), 
               psanova = FALSE)
#####################  GAM + GEO Model
gamgeo2d &lt;- pspatfit(form2, data = ames_sf1)
summary(gamgeo2d)

gamgeo2dsar &lt;- pspatfit(form2, data = ames_sf1,
                        type = "sar", 
                        listw = lw_ames, 
                        method = "Chebyshev")
summary(gamgeo2dsar)
### Models with psanova 2d spatial trend
form3 &lt;- lnSale_Price ~ Fireplaces + Garage_Cars +
          pspl(lnLot_Area, nknots = 20) + 
          pspl(lnTotal_Bsmt_SF, nknots = 20) +
          pspl(lnGr_Liv_Area, nknots = 20) +
          pspt(Longitude, Latitude, 
               nknots = c(10, 10), 
               psanova = TRUE)
gamgeo2danovasar &lt;- pspatfit(form3, data = ames_sf1,
                        type = "sar", 
                        listw = lw_ames, method = "Chebyshev")
summary(gamgeo2danovasar)
 ###############################################
###################### Examples using a panel data of rate of
###################### unemployment for 103 Italian provinces in 1996-2019.
 ###############################################
## load spatial panel and Wsp_it
## 103 Italian provinces. Period 1996-2019
data(unemp_it, package = "pspatreg")
## Wsp_it is a matrix. Create a neighboord list 
lwsp_it &lt;- spdep::mat2listw(Wsp_it, style = "W")
 ### Spatio-temporal semiparametric ANOVA model 
 ### Interaction terms f12,f1t,f2t and f12t with nested basis
 ### Remark: nest_sp1, nest_sp2 and nest_time must be divisors of nknots
 form4 &lt;- unrate ~ partrate + agri + cons +
                   pspl(serv, nknots = 15) + 
                   pspl(empgrowth, nknots = 20) +
                   pspt(long, lat, year, 
                        nknots = c(18, 18, 8), 
                        psanova = TRUE, 
                        nest_sp1 = c(1, 2, 2), 
                        nest_sp2 = c(1, 2, 2),
                        nest_time = c(1, 2, 2))
 sptanova &lt;- pspatfit(form4, data = unemp_it)
 summary(sptanova)
 

 ################################################  
 ### Interaction terms f1t not included in ANOVA decomposition
 form5 &lt;- unrate ~ partrate + agri + cons +
                   pspl(serv, nknots = 15) + 
                   pspl(empgrowth, nknots=20) +
                   pspt(long, lat, year, 
                        nknots = c(18, 18, 8),
                        psanova = TRUE, 
                        nest_sp1 = c(1, 2, 3), 
                        nest_sp2 = c(1, 2, 3),
                        nest_time = c(1, 2, 2), 
                        f1t_int = FALSE)
 ## Add sar specification and ar1 temporal correlation 
 sptanova2_sar_ar1 &lt;- pspatfit(form5, data = unemp_it, 
                              listw = lwsp_it, 
                              type = "sar",
                              cor = "ar1")
summary(sptanova2_sar_ar1)                                 
 
</code></pre>


</div>