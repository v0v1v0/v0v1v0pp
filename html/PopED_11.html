<div class="container">

<table style="width: 100%;"><tr>
<td>calc_ofv_and_grad</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Compute an objective function and gradient</h2>

<h3>Description</h3>

<p>Compute an objective function and gradient with respect to the optimization parameters.
This function can be passed to the Broyden Fletcher Goldfarb Shanno (BFGS) 
method for nonlinear minimization with box constraints implemented in <code>bfgsb_min</code>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">calc_ofv_and_grad(
  x,
  optxt,
  opta,
  model_switch,
  aa,
  axt,
  groupsize,
  ni,
  xtopto,
  xopto,
  aopto,
  bpop,
  d,
  sigma,
  docc_full,
  poped.db,
  only_fim = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>x</code></td>
<td>
<p>A matrix for the discrete design variables.  Each row is a group.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>optxt</code></td>
<td>
<p>If sampling times are optimized</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>opta</code></td>
<td>
<p>If continuous design variables are optimized</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model_switch</code></td>
<td>
<p>A matrix that is the same size as xt, specifying which model each sample belongs to.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>aa</code></td>
<td>
<p>The aa value</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>axt</code></td>
<td>
<p>the axt value</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>groupsize</code></td>
<td>
<p>A vector of the number of individuals in each group.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>ni</code></td>
<td>
<p>A vector of the number of samples in each group.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xtopto</code></td>
<td>
<p>the xtopto value</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>xopto</code></td>
<td>
<p>the xopto value</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>aopto</code></td>
<td>
<p>the aopto value</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bpop</code></td>
<td>
<p>Matrix defining the fixed effects, per row (row number = parameter_number) we should have:
</p>

<ul>
<li>
<p> column 1 the type of the distribution for E-family designs (0 = Fixed, 1 = Normal, 2 = Uniform,
3 = User Defined Distribution, 4 = lognormal and 5 = truncated normal)
</p>
</li>
<li>
<p> column 2  defines the mean.
</p>
</li>
<li>
<p> column 3 defines the variance of the distribution (or length of uniform distribution).
</p>
</li>
</ul>
<p>Can also just supply the parameter values as a vector <code>c()</code> if no uncertainty around the 
parameter value is to be used. The parameter order of  'bpop' is defined in the 'fg_fun' or 'fg_file'. If you use named 
arguments in 'bpop' then the order of this vector can be rearranged to match the 'fg_fun' or 'fg_file'. 
See 'reorder_parameter_vectors'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>d</code></td>
<td>
<p>Matrix defining the diagonals of the IIV (same logic as for the fixed effects 
matrix bpop to define uncertainty). One can also just supply the parameter values as a <code>c()</code>. 
The parameter order of 'd' is defined in the 'fg_fun' or 'fg_file'. If you use named 
arguments in 'd' then the order of this vector can be rearranged to match the 'fg_fun' or 'fg_file'. 
See 'reorder_parameter_vectors'.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sigma</code></td>
<td>
<p>Matrix defining the variances can covariances of the residual variability terms of the model.
can also just supply the diagonal parameter values (variances) as a <code>c()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>docc_full</code></td>
<td>
<p>A between occasion variability matrix.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>poped.db</code></td>
<td>
<p>A PopED database.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>only_fim</code></td>
<td>
<p>Should the gradient be calculated?</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A list containing:
</p>
<table>
<tr style="vertical-align: top;">
<td><code>f</code></td>
<td>
<p>The objective function.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>g</code></td>
<td>
<p>The gradient.</p>
</td>
</tr>
</table>
<h3>See Also</h3>

<p>Other Optimize: 
<code>Doptim()</code>,
<code>LEDoptim()</code>,
<code>RS_opt()</code>,
<code>a_line_search()</code>,
<code>bfgsb_min()</code>,
<code>calc_autofocus()</code>,
<code>mfea()</code>,
<code>optim_ARS()</code>,
<code>optim_LS()</code>,
<code>poped_optim()</code>,
<code>poped_optim_1()</code>,
<code>poped_optim_2()</code>,
<code>poped_optim_3()</code>,
<code>poped_optimize()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">library(PopED)

############# START #################
## Create PopED database
## (warfarin model for optimization)
#####################################

## Warfarin example from software comparison in:
## Nyberg et al., "Methods and software tools for design evaluation 
##   for population pharmacokinetics-pharmacodynamics studies", 
##   Br. J. Clin. Pharm., 2014. 

## Optimization using an additive + proportional reidual error  
## to avoid sample times at very low concentrations (time 0 or very late samples).

## find the parameters that are needed to define from the structural model
ff.PK.1.comp.oral.sd.CL

## -- parameter definition function 
## -- names match parameters in function ff
sfg &lt;- function(x,a,bpop,b,bocc){
  parameters=c(CL=bpop[1]*exp(b[1]),
               V=bpop[2]*exp(b[2]),
               KA=bpop[3]*exp(b[3]),
               Favail=bpop[4],
               DOSE=a[1])
  return(parameters) 
}

## -- Define initial design  and design space
poped.db &lt;- create.poped.database(ff_fun=ff.PK.1.comp.oral.sd.CL,
                                  fg_fun=sfg,
                                  fError_fun=feps.add.prop,
                                  bpop=c(CL=0.15, V=8, KA=1.0, Favail=1), 
                                  notfixed_bpop=c(1,1,1,0),
                                  d=c(CL=0.07, V=0.02, KA=0.6), 
                                  sigma=c(prop=0.01,add=0.25),
                                  groupsize=32,
                                  xt=c( 0.5,1,2,6,24,36,72,120),
                                  minxt=0.01,
                                  maxxt=120,
                                  a=c(DOSE=70),
                                  mina=c(DOSE=0.01),
                                  maxa=c(DOSE=100))

############# END ###################
## Create PopED database
## (warfarin model for optimization)
#####################################


opta=TRUE
aa=opta*poped.db$settings$cfaa*matrix(1,poped.db$design$m,size(poped.db$design$a,2))
aa

optxt=TRUE
axt=optxt*poped.db$settings$cfaxt*matrix(1,poped.db$design$m,max(poped.db$design_space$maxni))
axt

calc_ofv_and_grad(x=c(poped.db$design$xt,poped.db$design$a),
                  optxt=optxt, opta=opta, 
                  model_switch=poped.db$design$model_switch,
                  aa=aa,
                  axt=axt,
                  groupsize=poped.db$design$groupsize,
                  ni=poped.db$design$ni,
                  xtopto=poped.db$design$xt,
                  xopto=poped.db$design$x,
                  aopto=poped.db$design$a,
                  bpop=poped.db$parameters$param.pt.val$bpop,
                  d=poped.db$parameters$param.pt.val$d,
                  sigma=poped.db$parameters$param.pt.val$sigma,
                  docc_full=poped.db$parameters$param.pt.val$docc,
                  poped.db,
                  only_fim=FALSE)

## Not run: 
  
  # BFGS search, DOSE and sample time optimization
  bfgs.output &lt;- poped_optimize(poped.db,opt_xt=1,opt_a=1,
                                bUseRandomSearch= 0,
                                bUseStochasticGradient = 0,
                                bUseBFGSMinimizer = 1,
                                bUseLineSearch = 0)
  

## End(Not run)




</code></pre>


</div>