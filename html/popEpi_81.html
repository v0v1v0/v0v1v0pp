<div class="container">

<table style="width: 100%;"><tr>
<td>survtab_ag</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Estimate Survival Time Functions</h2>

<h3>Description</h3>

<p>This function estimates survival time functions: survival, 
relative/net survival, and crude/absolute risk functions (CIF).
</p>


<h3>Usage</h3>

<pre><code class="language-R">survtab_ag(
  formula = NULL,
  data,
  adjust = NULL,
  weights = NULL,
  surv.breaks = NULL,
  n = "at.risk",
  d = "from0to1",
  n.cens = "from0to0",
  pyrs = "pyrs",
  d.exp = "d.exp",
  n.pp = NULL,
  d.pp = "d.pp",
  d.pp.2 = "d.pp.2",
  n.cens.pp = "n.cens.pp",
  pyrs.pp = "pyrs.pp",
  d.exp.pp = "d.exp.pp",
  surv.type = "surv.rel",
  surv.method = "hazard",
  relsurv.method = "e2",
  subset = NULL,
  conf.level = 0.95,
  conf.type = "log-log",
  verbose = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>formula</code></td>
<td>
<p>a <code>formula</code>; the response 
must be the time scale to compute survival time function estimates
over, e.g. <code>fot ~ sex</code>. Variables on the right-hand side of the formula
separated by <code>+</code> are considered stratifying variables, for which 
estimates are computed separately. May contain usage of <code>adjust()</code> 
— see Details and Examples.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>since popEpi 0.4.0, a <code>data.frame</code>
containing variables used in <code>formula</code> and other arguments.
<code>aggre</code> objects are recommended as they contain information on any
time scales and are therefore safer; for creating <code>aggre</code> objects see
<code>as.aggre</code> when your data is already aggregated and <code>aggre</code>
for aggregating split <code>Lexis</code> objects.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>adjust</code></td>
<td>
<p>can be used as an alternative to passing variables to 
argument <code>formula</code> within a call to <code>adjust()</code>; e.g.
<code>adjust = "agegr"</code>. Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weights</code></td>
<td>
<p>typically a list of weights or a <code>character</code> string
specifying an age group standardization scheme; see
the dedicated help page 
and examples. NOTE: <code>weights = "internal"</code> is based on the counts
of persons in follow-up at the start of follow-up (typically T = 0)</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>surv.breaks</code></td>
<td>
<p>a vector of breaks on the 
survival time scale. Optional if <code>data</code> is an <code>aggre</code> object
and mandatory otherwise. Must define each intended interval;
e.g. <code>surv.breaks = 0:5</code> when data has intervals defined by 
breaks <code>seq(0, 5, 1/12)</code> will aggregate to wider intervals first.
It is generally recommended (and sufficient; 
see Seppa, Dyban and Hakulinen (2015)) to use monthly
intervals where applicable.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n</code></td>
<td>
<p>variable containing counts of subjects at-risk at the start of a 
time interval; e.g. <code>n = "at.risk"</code>. 
Required when <code>surv.method = "lifetable"</code>.
Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>d</code></td>
<td>
<p>variable(s) containing counts of subjects experiencing an event. 
With only one type of event, e.g. <code>d = "deaths"</code>. With multiple types of 
events (for CIF or cause-specific survival estimation), supply e.g.
<code>d = c("canD", "othD")</code>. If the survival time function to be estimated
does not use multiple types of events, supplying more than one variable
to <code>d</code> simply causes the variables to be added together. 
Always required. Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n.cens</code></td>
<td>
<p>variable containing counts of subjects censored during a 
survival time interval; E.g. <code>n.cens = "alive"</code>.
Required when <code>surv.method = "lifetable"</code>. 
Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pyrs</code></td>
<td>
<p>variable containing total subject-time accumulated within a 
survival time interval; E.g. <code>pyrs = "pyrs"</code>. 
Required when <code>surv.method = "hazard"</code>. Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>d.exp</code></td>
<td>
<p>variable denoting total "expected numbers of events" 
(typically computed <code>pyrs * pop.haz</code>, where 
<code>pop.haz</code> is the expected hazard level) 
accumulated within a survival time interval; E.g. <code>pyrs = "pyrs"</code>.
Required when computing EdererII relative survivals or 
CIFs based on excess counts of events. Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n.pp</code></td>
<td>
<p>variable containing total Pohar-Perme weighted counts of
subjects at risk in an interval,
supplied as argument <code>n</code> is supplied. 
Computed originally on the subject
level as analogous to <code>pp * as.integer(status == "at-risk")</code>.
Required when <code>relsurv.method = "pp"</code>. Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>d.pp</code></td>
<td>
<p>variable(s) containing Pohar-Perme weighted counts of events,
supplied as argument <code>d</code> is supplied. Computed originally on the subject
level as analogous to <code>pp * as.integer(status == some_event)</code>.
Required when <code>relsurv.method = "pp"</code>. Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>d.pp.2</code></td>
<td>
<p>variable(s) containing total Pohar-Perme 
"double-weighted" counts of events,
supplied as argument <code>d</code> is supplied. Computed originally on the subject
level as analogous to <code>pp * pp * as.integer(status == some_event)</code>.
Required when <code>relsurv.method = "pp"</code>. Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>n.cens.pp</code></td>
<td>
<p>variable containing total Pohar-Perme weighted counts 
censorings,
supplied as argument <code>n.cens</code> is supplied. 
Computed originally on the subject
level as analogous to <code>pp * as.integer(status == "censored")</code>.
Required when <code>relsurv.method = "pp"</code>. Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>pyrs.pp</code></td>
<td>
<p>variable containing total Pohar-Perme weighted subject-times,
supplied as argument <code>pyrs</code> is supplied. 
Computed originally on the subject
level as analogous to <code>pp * pyrs</code>.
Required when <code>relsurv.method = "pp"</code>. Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>d.exp.pp</code></td>
<td>
<p>variable containing total Pohar-Perme weighted counts 
of excess events,
supplied as argument <code>pyrs</code> is supplied. 
Computed originally on the subject
level as analogous to <code>pp * d.exp</code>.
Required when <code>relsurv.method = "pp"</code>. Flexible input.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>surv.type</code></td>
<td>
<p>one of <code>'surv.obs'</code>,
<code>'surv.cause'</code>, <code>'surv.rel'</code>, 
<code>'cif.obs'</code> or <code>'cif.rel'</code>; 
defines what kind of survival time function(s) is/are estimated; see Details</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>surv.method</code></td>
<td>
<p>either <code>'lifetable'</code> or <code>'hazard'</code>; determines
the method of calculating survival time functions, where the former computes
ratios such as <code>p = d/(n - n.cens)</code> 
and the latter utilizes subject-times 
(typically person-years) for hazard estimates such as <code>d/pyrs</code> 
which are used to compute survival time function estimates.
The former method requires argument <code>n.cens</code> and the latter 
argument <code>pyrs</code> to be supplied.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>relsurv.method</code></td>
<td>
<p>either <code>'e2'</code> or <code>'pp'</code>; 
defines whether to compute relative survival using the
EdererII method or using Pohar-Perme weighting;
ignored if <code>surv.type != "surv.rel"</code></p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>subset</code></td>
<td>
<p>a logical condition; e.g. <code>subset = sex == 1</code>; 
subsets the data before computations</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>conf.level</code></td>
<td>
<p>confidence level used in confidence intervals; 
e.g. <code>0.95</code> for 95 percent confidence intervals</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>conf.type</code></td>
<td>
<p>character string; must be one of <code>"plain"</code>, 
<code>"log-log"</code> and <code>"log"</code>; 
defines the transformation used on the survival time
function to yield confidence 
intervals via the delta method</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>logical; if <code>TRUE</code>, the function is chatty and
returns some messages and timings along the process</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>Returns a table of life time function values and other 
information with survival intervals as rows.
Returns some of the following estimates of survival time functions:
</p>

<ul>
<li> <p><code>surv.obs</code> - observed (raw, overall) survival
</p>
</li>
<li> <p><code>surv.obs.K</code> - observed cause-specific survival for cause K
</p>
</li>
<li> <p><code>CIF_k</code> - cumulative incidence function for cause <code>k</code>
</p>
</li>
<li> <p><code>CIF.rel</code> - cumulative incidence function using excess cases
</p>
</li>
<li> <p><code>r.e2</code> -  relative survival, EdererII
</p>
</li>
<li> <p><code>r.pp</code> -  relative survival, Pohar-Perme weighted
</p>
</li>
</ul>
<p>The suffix <code>.as</code> implies adjusted estimates, and <code>.lo</code> and
<code>.hi</code> imply lower and upper confidence limits, respectively. 
The prefix <code>SE.</code> stands for standard error.
</p>


<h3>Basics</h3>

<p>This function computes interval-based estimates of survival time functions,
where the intervals are set by the user. For product-limit-based
estimation see packages <span class="pkg">survival</span> and <span class="pkg">relsurv</span>.
</p>
<p>if <code>surv.type = 'surv.obs'</code>, only 'raw' observed survival 
is estimated over the chosen time intervals. With
<code>surv.type = 'surv.rel'</code>, also relative survival estimates 
are supplied in addition to observed survival figures. 
</p>
<p><code>surv.type = 'cif.obs'</code> requests cumulative incidence functions (CIF) 
to be estimated. 
CIFs are estimated for each competing risk based 
on a survival-interval-specific proportional hazards
assumption as described by Chiang (1968).  
With <code>surv.type = 'cif.rel'</code>, a CIF is estimated with using 
excess cases as the ”cause-specific” cases. Finally, with 
<code>surv.type = 'surv.cause'</code>, cause-specific survivals are 
estimated separately for each separate type of event. 
</p>
<p>In hazard-based estimation (<code>surv.method = "hazard"</code>) survival
time functions are transformations of the estimated corresponding hazard
in the intervals. The hazard itself is estimated using counts of events
(or excess events) and total subject-time in the interval. Life table
<code>surv.method = "lifetable"</code> estimates are constructed as transformations 
of probabilities computed using counts of events and counts of subjects 
at risk.
</p>
<p>The vignette <a href="../doc/survtab_examples.html">survtab_examples</a> 
has some practical examples.
</p>


<h3>Relative survival</h3>

<p>When <code>surv.type = 'surv.rel'</code>, the user can choose 
<code>relsurv.method = 'pp'</code>, whereupon Pohar-Perme weighting is used.
By default <code>relsurv.method = 'e2'</code>, i.e. the Ederer II method
is used to estimate relative survival.
</p>


<h3>Adjusted estimates</h3>

<p>Adjusted estimates in this context mean computing estimates separately
by the levels of adjusting variables and returning weighted averages
of the estimates. For example, computing estimates separately by
age groups and returning a weighted average estimate (age-adjusted estimate).
</p>
<p>Adjusting requires specification of both the adjusting variables and
the weights for all the levels of the adjusting variables. The former can be
accomplished by using <code>adjust()</code> with the argument <code>formula</code>,
or by supplying variables directly to argument <code>adjust</code>. E.g. the
following are all equivalent:
</p>
<p><code>formula = fot ~ sex + adjust(agegr) + adjust(area)</code>
</p>
<p><code>formula = fot ~ sex + adjust(agegr, area)</code>
</p>
<p><code>formula  = fot ~ sex, adjust = c("agegr", "area")</code>
</p>
<p><code>formula  = fot ~ sex, adjust = list(agegr, area)</code>
</p>
<p>The adjusting variables must match with the variable names in the
argument <code>weights</code>;
see the dedicated help page. 
Typically weights are supplied as a <code>list</code> or
a <code>data.frame</code>. The former can be done by e.g.
</p>
<p><code>weights = list(agegr = VEC1, area = VEC2)</code>,
</p>
<p>where <code>VEC1</code> and <code>VEC2</code> are vectors of weights (which do not
have to add up to one). See 
<a href="../doc/survtab_examples.html">survtab_examples</a> 
for an example of using a <code>data.frame</code> to pass weights.
</p>


<h3>Period analysis and other data selection schemes</h3>

<p>To calculate e.g. period analysis (delayed entry) estimates, 
limit the data when/before supplying to this function.See 
<a href="../doc/survtab_examples.html">survtab_examples</a>.
</p>


<h3>Data requirements</h3>

<p><code>survtab_ag</code> computes estimates of survival time functions using 
pre-aggregated data. For using subject-level data directly, use 
<code>survtab</code>. For aggregating data, see <code>lexpand</code>
and <code>aggre</code>. 
</p>
<p>By default, and if data is an <code>aggre</code> object (not mandatory), 
<code>survtab_ag</code> makes use of the exact same breaks that were used in 
splitting the original data (with e.g. <code>lexpand</code>), so it is not 
necessary to specify any <code>surv.breaks</code>. If specified, the 
<code>surv.breaks</code> must be a subset of the pertinent 
pre-existing breaks. When data is not an <code>aggre</code> object, breaks
must always be specified. Interval lengths (<code>delta</code> in output) are 
also calculated based on whichever breaks are used, 
so the upper limit of the breaks should
therefore be meaningful and never e.g. <code>Inf</code>.
</p>


<h3>References</h3>

<p>Perme, Maja Pohar, Janez Stare, and Jacques Esteve. 
"On estimation in relative survival." Biometrics 68.1 (2012): 113-120.
<a href="https://doi.org/10.1111/j.1541-0420.2011.01640.x">doi:10.1111/j.1541-0420.2011.01640.x</a>
</p>
<p>Hakulinen, Timo, Karri Seppa, and Paul C. Lambert. 
"Choosing the relative survival method for cancer survival estimation." 
European Journal of Cancer 47.14 (2011): 2202-2210.
<a href="https://doi.org/10.1016/j.ejca.2011.03.011">doi:10.1016/j.ejca.2011.03.011</a>
</p>
<p>Seppa, Karri, Timo Hakulinen, and Arun Pokhrel. 
"Choosing the net survival method for cancer survival estimation." 
European Journal of Cancer (2013).
<a href="https://doi.org/10.1016/j.ejca.2013.09.019">doi:10.1016/j.ejca.2013.09.019</a>
</p>
<p>CHIANG, Chin Long. Introduction to stochastic processes in biostatistics. 
1968. ISBN-14: 978-0471155003
</p>
<p>Seppa K., Dyba T. and Hakulinen T.: Cancer Survival, 
Reference Module in Biomedical Sciences. Elsevier. 08-Jan-2015.
<a href="https://doi.org/10.1016/B978-0-12-801238-3.02745-8">doi:10.1016/B978-0-12-801238-3.02745-8</a>
</p>


<h3>See Also</h3>

<p><code>splitMulti</code>, <code>lexpand</code>, 
<code>ICSS</code>, <code>sire</code>
<a href="../doc/survtab_examples.html">The survtab_examples vignette</a>
</p>
<p>Other main functions: 
<code>Surv()</code>,
<code>rate()</code>,
<code>relpois()</code>,
<code>relpois_ag()</code>,
<code>sir()</code>,
<code>sirspline()</code>,
<code>survmean()</code>,
<code>survtab()</code>
</p>
<p>Other survtab functions: 
<code>Surv()</code>,
<code>lines.survtab()</code>,
<code>plot.survtab()</code>,
<code>print.survtab()</code>,
<code>summary.survtab()</code>,
<code>survtab()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## see more examples with explanations in vignette("survtab_examples")

#### survtab_ag usage

data("sire", package = "popEpi")
## prepare data for e.g. 5-year "period analysis" for 2008-2012
## note: sire is a simulated cohort integrated into popEpi.
BL &lt;- list(fot=seq(0, 5, by = 1/12),
           per = c("2008-01-01", "2013-01-01"))
x &lt;- lexpand(sire, birth = bi_date, entry = dg_date, exit = ex_date,
             status = status %in% 1:2,
             breaks = BL,
             pophaz = popmort,
             aggre = list(fot))
             
## calculate relative EdererII period method
## NOTE: x is an aggre object here, so surv.breaks are deduced
## automatically
st &lt;- survtab_ag(fot ~ 1, data = x)

summary(st, t = 1:5) ## annual estimates
summary(st, q = list(r.e2 = 0.75)) ## 1st interval where r.e2 &lt; 0.75 at end

plot(st)


## non-aggre data: first call to survtab_ag would fail
df &lt;- data.frame(x)
# st &lt;- survtab_ag(fot ~ 1, data = x)
st &lt;- survtab_ag(fot ~ 1, data = x, surv.breaks = BL$fot)

## calculate age-standardised 5-year relative survival ratio using 
## Ederer II method and period approach 

sire$agegr &lt;- cut(sire$dg_age,c(0,45,55,65,75,Inf),right=FALSE)
BL &lt;- list(fot=seq(0, 5, by = 1/12),
           per = c("2008-01-01", "2013-01-01"))
x &lt;- lexpand(sire, birth = bi_date, entry = dg_date, exit = ex_date,
             status = status %in% 1:2,
             breaks = BL,
             pophaz = popmort,
             aggre = list(agegr, fot))

## age standardisation using internal weights (age distribution of 
## patients diagnosed within the period window)
## (NOTE: what is done here is equivalent to using weights = "internal")
w &lt;- aggregate(at.risk ~ agegr, data = x[x$fot == 0], FUN = sum)
names(w) &lt;- c("agegr", "weights")

st &lt;- survtab_ag(fot ~ adjust(agegr), data = x, weights = w)
plot(st, y = "r.e2.as", col = c("blue"))

## age standardisation using ICSS1 weights
data(ICSS)
cut &lt;- c(0, 45, 55, 65, 75, Inf)
agegr &lt;- cut(ICSS$age, cut, right = FALSE)
w &lt;- aggregate(ICSS1~agegr, data = ICSS, FUN = sum)
names(w) &lt;- c("agegr", "weights")

st &lt;- survtab_ag(fot ~ adjust(agegr), data = x, weights = w)
lines(st, y = "r.e2.as", col = c("red"))


## cause-specific survival
sire$stat &lt;- factor(sire$status, 0:2, c("alive", "canD", "othD"))
x &lt;- lexpand(sire, birth = bi_date, entry = dg_date, exit = ex_date,
             status = stat,
             breaks = BL,
             pophaz = popmort,
             aggre = list(agegr, fot))
st &lt;- survtab_ag(fot ~ adjust(agegr), data = x, weights = w,
                 d = c("fromalivetocanD", "fromalivetoothD"),
                 surv.type = "surv.cause")
plot(st, y = "surv.obs.fromalivetocanD.as")
lines(st, y = "surv.obs.fromalivetoothD.as", col = "red")



</code></pre>


</div>