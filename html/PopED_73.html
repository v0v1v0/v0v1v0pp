<div class="container">

<table style="width: 100%;"><tr>
<td>plot_model_prediction</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Plot model predictions</h2>

<h3>Description</h3>

<p>Function plots model predictions for the typical value in the population,
individual predictions and data predictions.
</p>


<h3>Usage</h3>

<pre><code class="language-R">plot_model_prediction(
  poped.db,
  model_num_points = 100,
  groupsize_sim = 100,
  separate.groups = F,
  sample.times = T,
  sample.times.IPRED = F,
  sample.times.DV = F,
  PRED = T,
  IPRED = F,
  IPRED.lines = F,
  IPRED.lines.pctls = F,
  alpha.IPRED.lines = 0.1,
  alpha.IPRED = 0.3,
  sample.times.size = 4,
  DV = F,
  alpha.DV = 0.3,
  DV.lines = F,
  DV.points = F,
  alpha.DV.lines = 0.3,
  alpha.DV.points = 0.3,
  sample.times.DV.points = F,
  sample.times.DV.lines = F,
  alpha.sample.times.DV.points = 0.3,
  alpha.sample.times.DV.lines = 0.3,
  y_lab = "Model Predictions",
  facet_scales = "fixed",
  facet_label_names = T,
  model.names = NULL,
  DV.mean.sd = FALSE,
  PI = FALSE,
  PI_alpha = 0.3,
  ...
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>poped.db</code></td>
<td>
<p>A PopED database.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model_num_points</code></td>
<td>
<p>How many extra observation rows should be created in the data frame for each group or individual 
per model.  If used then the points are placed evenly between <code>model_minxt</code> and <code>model_maxxt</code>. This option
is used by <code>plot_model_prediction</code> to simulate the response of the model on a finer grid then the defined design.
If <code>NULL</code> then only the input design is used.  Can be a single value or a vector the same length as the number of models.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>groupsize_sim</code></td>
<td>
<p>How many individuals per group  should be 
simulated when DV=TRUE or IPRED=TRUE to create prediction intervals?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>separate.groups</code></td>
<td>
<p>Should there be separate plots for each group.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sample.times</code></td>
<td>
<p>Should sample times be shown on the plots.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sample.times.IPRED</code></td>
<td>
<p>Should sample times be shown based on the IPRED y-values.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sample.times.DV</code></td>
<td>
<p>Should sample times be shown based on the DV y-values.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>PRED</code></td>
<td>
<p>Should a PRED line be drawn.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>IPRED</code></td>
<td>
<p>Should we simulate individual predictions?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>IPRED.lines</code></td>
<td>
<p>Should IPRED lines be drawn?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>IPRED.lines.pctls</code></td>
<td>
<p>Should lines be drawn at the chosen percentiles of the IPRED values?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha.IPRED.lines</code></td>
<td>
<p>What should the transparency for the IPRED.lines be?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha.IPRED</code></td>
<td>
<p>What should the transparency of the IPRED CI?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sample.times.size</code></td>
<td>
<p>What should the size of the sample.times be?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>DV</code></td>
<td>
<p>should we simulate observations?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha.DV</code></td>
<td>
<p>What should the transparency of the DV CI?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>DV.lines</code></td>
<td>
<p>Should DV lines be drawn?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>DV.points</code></td>
<td>
<p>Should DV points be drawn?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha.DV.lines</code></td>
<td>
<p>What should the transparency for the DV.lines be?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha.DV.points</code></td>
<td>
<p>What should the transparency for the DV.points be?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sample.times.DV.points</code></td>
<td>
<p>TRUE or FALSE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>sample.times.DV.lines</code></td>
<td>
<p>TRUE or FALSE.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha.sample.times.DV.points</code></td>
<td>
<p>What should the transparency for the sample.times.DV.points be?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>alpha.sample.times.DV.lines</code></td>
<td>
<p>What should the transparency for the sample.times.DV.lines be?</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>y_lab</code></td>
<td>
<p>The label of the y-axis.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>facet_scales</code></td>
<td>
<p>Can be "free", "fixed", "free_x" or "free_y"</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>facet_label_names</code></td>
<td>
<p>TRUE or FALSE</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>model.names</code></td>
<td>
<p>A vector of names of the response model/s (the length of the 
vector should be equal to the number of response models). It is Null by default.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>DV.mean.sd</code></td>
<td>
<p>Plot the mean and standard deviation of simulated observations.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>PI</code></td>
<td>
<p>Plot prediction intervals for the expected data given the model.
Predictions are based on first-order approximations to 
the model variance and a normality assumption of that variance.  As such these computations are 
more approximate than using <code>DV=T</code> and <code>groupsize_sim = some large number</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>PI_alpha</code></td>
<td>
<p>The transparency of the PI.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>...</code></td>
<td>
<p>Additional arguments passed to the <code>model_prediction</code> function.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A ggplot object.  If you would like to further edit this plot don't 
forget to load the ggplot2 library using <code>library(ggplot2)</code>.
</p>


<h3>See Also</h3>

<p><code>model_prediction</code>
</p>
<p>Other evaluate_design: 
<code>evaluate.fim()</code>,
<code>evaluate_design()</code>,
<code>evaluate_power()</code>,
<code>get_rse()</code>,
<code>model_prediction()</code>,
<code>plot_efficiency_of_windows()</code>
</p>
<p>Other Simulation: 
<code>model_prediction()</code>,
<code>plot_efficiency_of_windows()</code>
</p>
<p>Other Graphics: 
<code>plot_efficiency_of_windows()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">## Warfarin example from software comparison in:
## Nyberg et al., "Methods and software tools for design evaluation 
##   for population pharmacokinetics-pharmacodynamics studies", 
##   Br. J. Clin. Pharm., 2014. 

library(PopED)

## find the parameters that are needed to define from the structural model
ff.PK.1.comp.oral.md.CL

## -- parameter definition function 
## -- names match parameters in function ff
sfg &lt;- function(x,a,bpop,b,bocc){
  parameters=c(CL=bpop[1]*exp(b[1]),
               V=bpop[2]*exp(b[2]),
               KA=bpop[3]*exp(b[3]),
               Favail=bpop[4],
               DOSE=a[1])
    return(parameters) 
}

## -- Define initial design  and design space
poped.db &lt;- create.poped.database(
  ff_fun=ff.PK.1.comp.oral.sd.CL,
  fg_fun=sfg,
  fError_fun=feps.prop,
  bpop=c(CL=0.15, V=8, KA=1.0, Favail=1), 
  notfixed_bpop=c(1,1,1,0),
  d=c(CL=0.07, V=0.02, KA=0.6), 
  sigma=0.01,
  groupsize=32,
  xt=c( 0.5,1,2,6,24,36,72,120),
  minxt=0,
  maxxt=120,
  a=70)

##  create plot of model without variability 
plot_model_prediction(poped.db)

##  create plot of model with variability by simulating from OMEGA and SIGMA
plot_model_prediction(poped.db,IPRED=TRUE,DV=TRUE)

##  create plot of model with variability by 
##  computing the expected variance (using an FO approximation) 
##  and then computing a prediction interval 
##  based on an assumption of normality
##  computation is faster but less accurate 
##  compared to using DV=TRUE (and groupsize_sim = 500)
plot_model_prediction(poped.db,PI=TRUE)

##-- Model: One comp first order absorption + inhibitory imax
## -- works for both mutiple and single dosing  
ff &lt;- function(model_switch,xt,parameters,poped.db){
  with(as.list(parameters),{
    
    y=xt
    MS &lt;- model_switch
    
    # PK model
    N = floor(xt/TAU)+1
    CONC=(DOSE*Favail/V)*(KA/(KA - CL/V)) * 
      (exp(-CL/V * (xt - (N - 1) * TAU)) * (1 - exp(-N * CL/V * TAU))/(1 - exp(-CL/V * TAU)) - 
         exp(-KA * (xt - (N - 1) * TAU)) * (1 - exp(-N * KA * TAU))/(1 - exp(-KA * TAU)))  
    
    # PD model
    EFF = E0*(1 - CONC*IMAX/(IC50 + CONC))
    
    y[MS==1] = CONC[MS==1]
    y[MS==2] = EFF[MS==2]
    
    return(list( y= y,poped.db=poped.db))
  })
}

## -- parameter definition function 
sfg &lt;- function(x,a,bpop,b,bocc){
  parameters=c( V=bpop[1]*exp(b[1]),
                KA=bpop[2]*exp(b[2]),
                CL=bpop[3]*exp(b[3]),
                Favail=bpop[4],
                DOSE=a[1],
                TAU = a[2],
                E0=bpop[5]*exp(b[4]),
                IMAX=bpop[6],
                IC50=bpop[7])
  return( parameters ) 
}


## -- Residual Error function
feps &lt;- function(model_switch,xt,parameters,epsi,poped.db){
  returnArgs &lt;- ff(model_switch,xt,parameters,poped.db) 
  y &lt;- returnArgs[[1]]
  poped.db &lt;- returnArgs[[2]]
  
  MS &lt;- model_switch
  
  pk.dv &lt;- y*(1+epsi[,1])+epsi[,2]
  pd.dv &lt;-  y*(1+epsi[,3])+epsi[,4]
  
  y[MS==1] = pk.dv[MS==1]
  y[MS==2] = pd.dv[MS==2]
  
  return(list( y= y,poped.db =poped.db )) 
}

poped.db &lt;- 
  create.poped.database(
    ff_fun=ff,
    fError_fun=feps,
    fg_fun=sfg,
    groupsize=20,
    m=3,
    bpop=c(V=72.8,KA=0.25,CL=3.75,Favail=0.9,
           E0=1120,IMAX=0.807,IC50=0.0993),  
    notfixed_bpop=c(1,1,1,0,1,1,1),
    d=c(V=0.09,KA=0.09,CL=0.25^2,E0=0.09), 
    sigma=c(0.04,5e-6,0.09,100),
    notfixed_sigma=c(0,0,0,0),
    xt=c( 1,2,8,240,240,1,2,8,240,240),
    minxt=c(0,0,0,240,240,0,0,0,240,240),
    maxxt=c(10,10,10,248,248,10,10,10,248,248),
    discrete_xt = list(0:248),
    G_xt=c(1,2,3,4,5,1,2,3,4,5),
    bUseGrouped_xt=1,
    model_switch=c(1,1,1,1,1,2,2,2,2,2),
    a=list(c(DOSE=20,TAU=24),c(DOSE=40, TAU=24),c(DOSE=0, TAU=24)),
    maxa=c(DOSE=200,TAU=40),
    mina=c(DOSE=0,TAU=2),
    ourzero=0)

##  create plot of model and design 
plot_model_prediction(poped.db,facet_scales="free",
                      model.names = c("PK","PD"))

##  create plot of model with variability by  
##  computing the expected variance (using an FO approximation) 
##  and then computing a prediction interval 
##  based on an assumption of normality
##  computation is faster but less accurate 
##  compared to using DV=TRUE (and groupsize_sim = 500)
plot_model_prediction(poped.db,facet_scales="free",
                      model.names = c("PK","PD"),
                      PI=TRUE,
                      separate.groups = TRUE)


</code></pre>


</div>