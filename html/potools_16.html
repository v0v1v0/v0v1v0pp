<div class="container">

<table style="width: 100%;"><tr>
<td>translate_package</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Interactively provide translations for a package's messages</h2>

<h3>Description</h3>

<p>This function handles the "grunt work" of building and updating translation
libraries. In addition to providing a friendly interface for supplying
translations, some internal logic is built to help make your package more
translation-friendly.
</p>
<p>To get started, the package developer should run <code>translate_package()</code> on
your package's source to produce a template <code>.pot</code> file (or files, if your
package has both R and C/C++ messages to translated), e.g.
</p>
<p>To add translations in your desired language, include the target language:
in the <code>translate_package(languages = "es")</code> call.
</p>


<h3>Usage</h3>

<pre><code class="language-R">translate_package(
  dir = ".",
  languages = NULL,
  diagnostics = list(check_cracked_messages, check_untranslated_cat,
    check_untranslated_src),
  custom_translation_functions = list(R = NULL, src = NULL),
  max_translations = Inf,
  use_base_rules = package %chin% .potools$base_package_names,
  copyright = NULL,
  bugs = "",
  verbose = !is_testing()
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>dir</code></td>
<td>
<p>Character, default the present directory; a directory in which an
R package is stored.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>languages</code></td>
<td>
<p>Character vector; locale codes to which to translate.
Must be a valid language accepted by gettext. This almost always takes
the form of (1) an ISO 639 2-letter language code; or (2) <code>ll_CC</code>, where
<code>ll</code> is an ISO 639 2-letter language code and <code>CC</code> is an ISO 3166 2-letter
country code e.g. <code>es</code> for Spanish, <code>es_AR</code> for Argentinian Spanish, <code>ro</code>
for Romanian, etc. See <code>base::Sys.getlocale()</code> for some helpful tips
about how to tell which locales are currently available on your machine, and
see the References below for some web resources listing more locales.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>diagnostics</code></td>
<td>
<p>A <code>list</code> of diagnostic functions to be run on the
package's message data. See Details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>custom_translation_functions</code></td>
<td>
<p>A <code>list</code> with either/both of two
components, <code>R</code> and <code>src</code>, together governing how to extract any
non-standard strings from the package. See Details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>max_translations</code></td>
<td>
<p>Numeric; used for setting a cap on the number of
translations to be done for each language. Defaults to <code>Inf</code>, meaning
all messages in the package.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>use_base_rules</code></td>
<td>
<p>Logical; Should internal behavior match base behavior
as strictly as possible? <code>TRUE</code> if being run on a base package (i.e.,
<code>base</code> or one of the default packages like <code>utils</code>,
<code>graphics</code>, etc.). See Details.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>copyright</code></td>
<td>
<p>Character; passed on to <code>write_po_file()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bugs</code></td>
<td>
<p>Character; passed on to <code>write_po_file()</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>verbose</code></td>
<td>
<p>Logical, default <code>TRUE</code> (except during testing). Should
extra information about progress, etc. be reported?</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>This function returns nothing invisibly. As a side effect, a
‘<span class="file">.pot</span>’ file is written to the package's ‘<span class="file">po</span>’ directory (updated if
one does not yet exist, or created from scratch otherwise), and a ‘<span class="file">.po</span>’
file is written in the same directory for each element of <code>languages</code>.
</p>


<h3>Phases</h3>

<p><code>translate_package()</code> goes through roughly three "phases" of translation.
</p>

<ol>
<li>
<p> Setup – <code>dir</code> is checked for existing translations
(toggling between "update" and "new" modes), and R files are parsed and
combed for user-facing messages.
</p>
</li>
<li>
<p> Diagnostics:  see the Diagnostics section below. Any
diagnostic detecting "unhealthy" messages will result in a yes/no prompt to
exit translation to address the issues before continuing.
</p>
</li>
<li>
<p> Translation. All of the messages found in phase one are iterated over –
the user is shown a message in English and prompted for the translation
in the target language. This process is repeated for each domain
in <code>languages</code>.
</p>
</li>
</ol>
<p>An attempt is made to provide hints for some translations that require
special care (e.g. that have escape sequences or use templates). For
templated messages (e.g., that use <code style="white-space: pre;">⁠%s⁠</code>), the user-provided message
must match the templates of the English message. The templates <em>don't</em>
have to be in the same order – R understands template reordering, e.g.
<code style="white-space: pre;">⁠%2$s⁠</code> says "interpret the second input as a string". See
<code>sprintf()</code> for more details.
</p>
<p>After each language is completed, a corresponding ‘<span class="file">.po</span>’ file is written
to the package's ‘<span class="file">po</span>’ directory (which is created if it does not yet
exist).
</p>
<p>There are some discrepancies in the default behavior of
<code>translate_package</code> and the translation workflow used to generate the
‘<span class="file">.po</span>’/‘<span class="file">.pot</span>’ files for R itself (mainly, the suite of functions
from <code>tools</code>, <code>tools::update_pkg_po()</code>,
<code>tools::xgettext2pot()</code>, <code>tools::xgettext()</code>, and
<code>tools::xngettext()</code>). They should only be superficial (e.g.,
whitespace or comments), but nevertheless may represent a barrier to
smoothly submitting patchings to R Core. To make the process of translating
base R and the default packages (<code>tools</code>, <code>utils</code>, <code>stats</code>,
etc.) as smooth as possible, set the <code>use_base_rules</code> argument to
<code>TRUE</code> and your resulting ‘<span class="file">.po</span>’/‘<span class="file">.pot</span>’/‘<span class="file">.mo</span>’ file will
match base's.
</p>


<h3>Custom translation functions</h3>

<p><code>base</code> R provides several functions for messaging that are natively equipped
for translation (they all have a <code>domain</code> argument): <code>stop()</code>, <code>warning()</code>,
<code>message()</code>, <code>gettext()</code>, <code>gettextf()</code>, <code>ngettext()</code>, and
<code>packageStartupMessage()</code>.
</p>
<p>While handy, some developers may prefer to write their own functions, or to
write wrappers of the provided functions that provide some enhanced
functionality (e.g., templating or automatic wrapping). In this case,
the default R tooling for translation (<code>xgettext()</code>, <code>xngettext()</code>
<code>xgettext2pot()</code>, <code>update_pkg_po()</code> from <code>tools</code>) will not work, but
<code>translate_package()</code> and its workhorse <code>get_message_data()</code> provide an
interface to continue building  translations for your workflow.
</p>
<p>Suppose you wrote a function <code>stopf()</code> that is a wrapper of
<code>stop(gettextf())</code> used to build templated error messages in R, which makes
translation easier for translators (see below), e.g.:
</p>
<div class="sourceCode R"><pre>stopf = function(fmt, ..., domain = NULL) {
  stop(gettextf(fmt, ...), domain = domain, call. = FALSE)
}
</pre></div>
<p>Note that <code>potools</code> itself uses just such a wrapper internally to build
error messages! To extract strings from calls in your package to <code>stopf()</code>
and mark them for translation, use the argument
<code>custom_translation_functions</code>:
</p>
<div class="sourceCode R"><pre>get_message_data(
  '/path/to/my_package',
  custom_translation_functions = list(R = 'stopf:fmt|1')
)
</pre></div>
<p>This invocation tells <code>get_message_data()</code> to look for strings in the
<code>fmt</code> argument in calls to <code>stopf()</code>. <code>1</code> indicates that <code>fmt</code> is the
first argument.
</p>
<p>This interface is inspired by the <code>--keyword</code> argument to the
<code>xgettext</code> command-line tool. This argument consists of a list with two
components, <code>R</code> and <code>src</code> (either can be excluded), owing to
differences between R and C/C++. Both components, if present, should consist
of a character vector.
</p>
<p>For R, there are two types of input: one for named arguments, the other for
unnamed arguments.
</p>

<ul>
<li>
<p> Entries for <strong>named</strong> arguments will look like <code>"fname:arg|num"</code> (singular
string) or <code>"fname:arg1|num1,arg2|num2"</code> (plural string). <code>fname</code>
gives the name of the function/call to be extracted from the R source,
<code>arg</code>/<code>arg1</code>/<code>arg2</code> specify the name of the argument to
<code>fname</code> from which strings should be extracted, and
<code>num</code>/<code>num1</code>/<code>num2</code> specify the <em>order</em> of the named
argument within the signature of <code>fname</code>.
</p>
</li>
<li>
<p> Entries for <strong>unnamed</strong> arguments will look like
<code>"fname:...\xarg1,...,xargn"</code>, i.e., <code>fname</code>, followed by
<code>:</code>, followed by <code>...</code> (three dots), followed by a backslash
(<code style="white-space: pre;">⁠\⁠</code>), followed by a comma-separated list of argument names. All
strings within calls to <code>fname</code> <em>except</em> those supplied to the
arguments named among <code>xarg1</code>, ..., <code>xargn</code> will be extracted.
</p>
</li>
</ul>
<p>To clarify, consider the how we would (redundantly) specify
<code>custom_translation_functions</code> for some of the default messagers,
<code>gettext</code>, <code>gettextf</code>, and <code>ngettext</code>:
<code>custom_translation_functions = list(R = c("gettext:...\domain", "gettextf:fmt|1", "ngettext:msg1|2,msg2|3"))</code>.
</p>
<p>For src, there is only one type of input, which looks like
<code>"fname:num"</code>, which says to look at the <code>num</code> argument of calls
to <code>fname</code> for <code>char</code> arrays.
</p>
<p>Note that there is a difference in how translation works for src vs. R – in
R, all strings passed to certain functions are considered marked for
translations, but in src, all translatable strings must be explicitly marked
as such. So for <code>src</code> translations, <code>custom_translation_functions</code>
is not used to customize which strings are marked for translation, but
rather, to expand the set of calls which are searched for potentially
<em>untranslated</em> arrays (i.e., arrays passed to the specified calls that
are not explicitly marked for translation). These can then be reported in
the <code>check_untranslated_src()</code> diagnostic, for example.
</p>


<h3>Diagnostics</h3>



<h4>Cracked messages</h4>

<p>A cracked message is one like:
</p>
<div class="sourceCode r"><pre>stop("There are ", n, " good things and ", m, " bad things.")
</pre></div>
<p>In its current state, translators will be asked to translate three messages
independently:
</p>

<ul>
<li>
<p> "There are"
</p>
</li>
<li>
<p> "good things and"
</p>
</li>
<li>
<p> "bad things."
</p>
</li>
</ul>
<p>The message has been cracked; it might not be possible to translate a string
as generic as "There are" into many languages – context is key!
</p>
<p>To keep the context, the error message should instead be build with
<code>gettextf</code> like so:
</p>
<div class="sourceCode r"><pre>stop(domain=NA, gettextf("There are %d good things and %d bad things."))
</pre></div>
<p>Now there is only one string to translate! Note that this also allows the
translator to change the word order as they see fit – for example, in
Japanese, the grammatical order usually puts the verb last (where in
English it usually comes right after the subject).
</p>
<p><code>translate_package</code> detects such cracked messages and suggests a
<code>gettextf</code>-based approach to fix them.
</p>



<h4>Untranslated R messages produced by <code>cat()</code>
</h4>

<p>Only strings which are passed to certain <code>base</code> functions are eligible for
translation, namely <code>stop</code>, <code>warning</code>, <code>message</code>, <code>packageStartupMessage</code>,
<code>gettext</code>, <code>gettextf</code>, and <code>ngettext</code> (all of which have a <code>domain</code> argument
that is key for translation).
</p>
<p>However, it is common to also produce some user-facing messages using
<code>cat</code> – if your package does so, it must first use <code>gettext</code> or <code>gettextf</code>
to translate the message before sending it to the user with <code>cat</code>.
</p>
<p><code>translate_package</code> detects strings produced with <code>cat</code> and suggests a
<code>gettext</code>- or <code>gettextf</code>-based fix.
</p>



<h4>Untranslated C/C++ messages</h4>

<p>This diagnostic detects any literal <code>char</code> arrays provided to common
messaging functions in C/C++, namely <code>ngettext()</code>, <code>Rprintf()</code>, <code>REprintf()</code>,
<code>Rvprintf()</code>, <code>REvprintf()</code>, <code>R_ShowMessage()</code>, <code>R_Suicide()</code>, <code>warning()</code>,
<code>Rf_warning()</code>, <code>error()</code>, <code>Rf_error()</code>, <code>dgettext()</code>, and <code>snprintf()</code>.
To actually translate these strings, pass them through the translation
macro <code style="white-space: pre;">⁠_⁠</code>.
</p>
<p>NB: Translation in C/C++ requires some additional <code style="white-space: pre;">⁠#include⁠</code>s and
declarations, including defining the <code style="white-space: pre;">⁠_⁠</code> macro.
See the Internationalization section of Writing R Extensions for details.
</p>



<h3>Custom diagnostics</h3>

<p>A diagnostic is a function which takes as input a <code>data.table</code>
summarizing the translatable strings in a package (e.g. as generated by
<code>get_message_data()</code>), evaluates whether these messages are
"healthy" in some sense, and produces a digest of "unhealthy" strings and
(optionally) suggested replacements.
</p>
<p>The diagnostic function must have an attribute named <code>diagnostic_tag</code>
that describes what the diagnostic does; it is reproduced in the format
<code>Found {nrow(result)} {diagnostic_tag}:</code>. For example,
<code>check_untranslated_cat()</code> has <code>diagnostic_tag = "untranslated messaging calls passed through cat()"</code>.
</p>
<p>The output diagnostic result has the following schema:
</p>

<ul>
<li> <p><code>call</code>: <code>character</code>, the call identified as problematic
</p>
</li>
<li> <p><code>file</code>: <code>character</code>, the file where <code>call</code> was found
</p>
</li>
<li> <p><code>line_number</code>: <code>integer</code>, the line in <code>file</code> where <code>call</code> was found
</p>
</li>
<li> <p><code>replacement</code>: <code>character</code>, <em>optional</em>, a suggested fix to make the call
"healthy"
</p>
</li>
</ul>
<p>See <code>check_cracked_messages()</code>,
<code>check_untranslated_cat()</code>, and
<code>check_untranslated_src()</code> for examples of diagnostics.
</p>


<h3>Author(s)</h3>

<p>Michael Chirico
</p>


<h3>References</h3>

<p><a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Internationalization">https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Internationalization</a>
<br><a href="https://cran.r-project.org/doc/manuals/r-release/R-admin.html#Internationalization">https://cran.r-project.org/doc/manuals/r-release/R-admin.html#Internationalization</a>
<br><a href="https://cran.r-project.org/doc/manuals/r-release/R-ints.html#Internationalization-in-the-R-sources">https://cran.r-project.org/doc/manuals/r-release/R-ints.html#Internationalization-in-the-R-sources</a>
<br><a href="https://developer.r-project.org/Translations30.html">https://developer.r-project.org/Translations30.html</a> <br><a href="https://web.archive.org/web/20230108213934/https://www.isi-web.org/resources/glossary-of-statistical-terms">https://web.archive.org/web/20230108213934/https://www.isi-web.org/resources/glossary-of-statistical-terms</a> <br><a href="https://www.gnu.org/software/gettext/">https://www.gnu.org/software/gettext/</a> <br><a href="https://www.gnu.org/software/gettext/manual/html_node/Usual-Language-Codes.html#Usual-Language-Codes">https://www.gnu.org/software/gettext/manual/html_node/Usual-Language-Codes.html#Usual-Language-Codes</a>
<br><a href="https://www.gnu.org/software/gettext/manual/html_node/Country-Codes.html#Country-Codes">https://www.gnu.org/software/gettext/manual/html_node/Country-Codes.html#Country-Codes</a>
<br><a href="https://www.stats.ox.ac.uk/pub/Rtools/goodies/gettext-tools.zip">https://www.stats.ox.ac.uk/pub/Rtools/goodies/gettext-tools.zip</a>
<br><a href="https://saimana.com/list-of-country-locale-code/">https://saimana.com/list-of-country-locale-code/</a>
</p>


<h3>See Also</h3>

<p><code>get_message_data()</code>, <code>write_po_file()</code>,
<code>tools::xgettext()</code>, <code>tools::update_pkg_po()</code>,
<code>tools::checkPoFile()</code>, <code>base::gettext()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">
pkg &lt;- system.file('pkg', package = 'potools')
# copy to a temporary location to be able to read/write/update below
tmp_pkg &lt;- file.path(tempdir(), "pkg")
dir.create(tmp_pkg)
file.copy(pkg, dirname(tmp_pkg), recursive = TRUE)

# run translate_package() without any languages
# this will generate a .pot template file and en@quot translations (in UTF-8 locales)
# we can also pass empty 'diagnostics' to skip the diagnostic step
# (skip if gettext isn't available to avoid an error)
if (isTRUE(check_potools_sys_reqs)) {
  translate_package(tmp_pkg, diagnostics = NULL)
}

## Not run: 
# launches the interactive translation dialog for translations into Estonian:
translate_package(tmp_pkg, "et_EE", diagnostics = NULL, verbose = TRUE)

## End(Not run)

# cleanup
unlink(tmp_pkg, recursive = TRUE)
rm(pkg, tmp_pkg)

</code></pre>


</div>