<div class="container">

<table style="width: 100%;"><tr>
<td>PSweight_cl</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Estimate average causal effects by propensity score weighting for a binary treatment with clustering.</h2>

<h3>Description</h3>

<p>The function <code>PSweight_cl</code> is used to estimate the average potential outcomes corresponding to
each treatment group among the target population with two-level data. The function currently implements
the following types of weights: the inverse probability of treatment weights (IPW: target population is the combined population),
average treatment effect among the treated weights (treated: target population is the population receiving a specified treatment),
overlap weights (overlap: target population is the overlap population at clinical equipoise), matching weights (matching: target population
is population obtained under 1:1 matching), entropy weights (entropy: target population is the population weighted by the entropy function).
Augmented propensity score weighting estimators are also allowed, with propensity scores and outcome model estimated
within the function through mixed effect model.
</p>


<h3>Usage</h3>

<pre><code class="language-R">PSweight_cl(
  ps.formula = NULL,
  trtgrp = NULL,
  yname,
  data,
  weight = "overlap",
  delta = 0,
  augmentation = FALSE,
  bootstrap = FALSE,
  bs_level = NULL,
  R = 50,
  out.formula = NULL,
  family = "gaussian",
  nAGQ = 1L
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>ps.formula</code></td>
<td>
<p>an object of class <code>formula</code> (or one that can be coerced to that class):
a symbolic description of the propensity score model to be fitted. Additional details of model specification
are given under "Details".</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>trtgrp</code></td>
<td>
<p>an optional character defining the "treated" population for estimating the average treatment
effect among the treated (ATT). Only necessary if <code>weight = "treated"</code>. This option can also be used to specify
the treatment (in a two-treatment setting) when a vector argument is supplied for <code>ps.estimate</code>.
Default value is the last group in the alphebatic order.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>yname</code></td>
<td>
<p>an optional character specifying the name of the outcome variable in <code>data</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>data</code></td>
<td>
<p>an optional data frame containing the variables in the propensity score model
and outcome model (if augmented estimator is used). If not found in data, the variables are
taken from <code>environment(formula)</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>weight</code></td>
<td>
<p>a character or vector of characters including the types of weights to be used.
<code>"IPW"</code> specifies the inverse probability of treatment weights for estimating the average treatment
effect among the combined population. <code>"treated"</code> specifies the weights for estimating the
average treatment effect among the treated. <code>"overlap"</code> specifies the (generalized) overlap weights
for estimating the average treatment effect among the overlap population, or population at
clinical equipoise. <code>"matching"</code> specifies the matching weights for estimating the average treatment effect
among the matched population (ATM). <code>"entropy"</code> specifies the entropy weights for the average treatment effect
of entropy weighted population (ATEN). Default is <code>"overlap"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>delta</code></td>
<td>
<p>trimming threshold for estimated (generalized) propensity scores.
Should be no larger than 1 / number of treatment groups. Default is 0, corresponding to no trimming.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>augmentation</code></td>
<td>
<p>logical. Indicate whether augmented weighting estimators should be used.
Default is <code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bootstrap</code></td>
<td>
<p>logical. Indaicate whether bootstrap is used to estimate the standard error
of the point estimates. Default is <code>FALSE</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>bs_level</code></td>
<td>
<p>an optional character defining the cluster level (name of the variable) for each bootstrap resampling.
Default is <code>NULL</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>R</code></td>
<td>
<p>an optional integer indicating number of bootstrap replicates. Default is <code>R = 50</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>out.formula</code></td>
<td>
<p>an object of class <code>formula</code> (or one that can be coerced to that class):
a symbolic description of the outcome model to be fitted. Additional details of model specification
are given under "Details". Different from the out.formula in <code>PSweight</code>, this <code>formula</code> should include the treatment label with cooresponding cluster forms.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>family</code></td>
<td>
<p>a description of the error distribution and link function to be used in the outcome model.
Only required if <code>out.formula</code> is provided. Supported distributional families include
<code>"gaussian" (link = identity)</code>, <code>"binomial" (link = logit)</code> and <code>"poisson" (link = log)</code>.
See <code>family</code> in <code>glm</code> for more details. Default is <code>"gaussian"</code>.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>nAGQ</code></td>
<td>
<p>integer scalar - the number of points per axis for evaluating the adaptive Gauss-Hermite approximation to the log-likelihood.
Defaults to 1, corresponding to the Laplace approximation. Please refer to lme4 package for more details.</p>
</td>
</tr>
</table>
<h3>Details</h3>

<p>A typical form for <code>ps.formula</code> is <code>treatment ~ terms+1|clusters</code> where <code>treatment</code> is the treatment
variable  and <code>terms</code> is a series of terms
which specifies a linear predictor for <code>treatment</code> and cluster level effects. Similarly, a typical form for <code>out.formula</code> is
<code>outcome ~ treatment+terms+1|cluster</code> where <code>outcome</code> is the outcome variable (identical to the variable name
used to specify <code>yname</code>); <code>terms</code> is a series of terms which specifies a linear
predictor for <code>outcome</code>; <code>clusters</code> is the random effects term for clusters. Both <code>ps.formula</code> and <code>out.formula</code> by default specify generalized
linear mixed effect models.
</p>
<p>Current version of <code>PSweight_cl</code> allows for five types of propensity score weights used to estimate ATE (IPW), ATT (treated) and
ATO (overlap), ATM (matching) and ATEN (entropy). These weights are members of larger class of balancing weights defined in Li, Morgan, and Zaslavsky (2018).
Specific definitions of these weights are provided in Li, Morgan, and Zaslavsky (2018), Li and Greene (2013), Zhou, Matsouaka and Thomas (2020).
When there is a practical violation of the positivity assumption, <code>delta</code> defines the symmetric
propensity score trimming rule following Crump et al. (2009). The overlap weights can also be considered as
a data-driven continuous trimming strategy without specifying trimming rules, see Li, Thomas and Li (2019).
Additional details on balancing weights and generalized overlap weights for multiple treatment groups are provided in
Li and Li (2019).
</p>
<p>If <code>augmentation = TRUE</code>, an augmented weighting estimator will be implemented. For binary treatments, the augmented
weighting estimator is presented in Mao, Li and Greene (2018). When
<code>weight = "IPW"</code>, the augmented estimator is also referred to as a doubly-robust (DR) estimator.
</p>
<p>When <code>bootstrap = TRUE</code>, the variance will be calculated by nonparametric bootstrap, with <code>R</code> bootstrap
replications. <code>bs_level</code> needs to be specified as the variable name for the cluster in order to conduct cluster
level resampling and maintaining the cluster level coorelation. The default value <code>NULL</code> treat each observation independently.
The default of <code>R</code> is 50. Otherwise, the variance will be calculated using the sandwich variance
formula obtained in the M-estimation framework.
</p>


<h3>Value</h3>

<p>PSweight_cl returns a <code>PSweight</code> object containing a list of the following values:
estimated propensity scores, average potential outcomes corresponding to each treatment,
variance-covariance matrix of the point estimates, the label for each treatment group,
and estimates in each bootstrap replicate if <code>bootstrap = TRUE</code>.
A summary of PSweight_cl can be obtained with <code>summary.PSweight</code>.
</p>

<dl>
<dt><code> trtgrp</code></dt>
<dd>
<p>a character indicating the treatment group.</p>
</dd>
<dt><code> propensity</code></dt>
<dd>
<p>a data frame of estimated propensity scores.</p>
</dd>
<dt><code> muhat</code></dt>
<dd>
<p> average potential outcomes by treatment groups, with reference to specific target populations.</p>
</dd>
<dt><code> covmu</code></dt>
<dd>
<p> variance-covariance matrix of <code>muhat</code>.</p>
</dd>
<dt><code> muboot</code></dt>
<dd>
<p> an optional list of point estimates in each bootstrap replicate <code>bootstrap = TRUE</code>.</p>
</dd>
<dt><code> group</code></dt>
<dd>
<p> a table of treatment group labels corresponding to the output point estimates <code>muhat</code>.</p>
</dd>
</dl>
<h3>References</h3>

<p>Li, F., Zaslavsky, A. M., Landrum, M. B. (2013).
Propensity score weighting with multilevel data. Statistics in Medicine, 32(19), 3373-3387.
</p>
<p>Fuentes, A., LÃ¼dtke, O., Robitzsch, A. (2021).
Causal inference with multilevel data: A comparison of different propensit score weighting appropaches. Multivariate Behavioral Research, 1-24.
</p>
<p>Crump, R. K., Hotz, V. J., Imbens, G. W., Mitnik, O. A. (2009).
Dealing with limited overlap in estimation of average treatment effects. Biometrika, 96(1), 187-199.
</p>
<p>Li, L., Greene, T. (2013).
A weighting analogue to pair matching in propensity score analysis. The International Journal of Biostatistics, 9(2), 215-234.
</p>
<p>Li, F., Morgan, K. L., Zaslavsky, A. M. (2018).
Balancing covariates via propensity score weighting.
Journal of the American Statistical Association, 113(521), 390-400.
</p>
<p>Mao, H., Li, L., Greene, T. (2019). Propensity score weighting analysis and treatment effect discovery.
Statistical Methods in Medical Research, 28(8), 2439-2454.
</p>
<p>Li, F., Thomas, L. E., Li, F. (2019).
Addressing extreme propensity scores via the overlap weights. American Journal of Epidemiology, 188(1), 250-257.
</p>
<p>Yoshida, K., Solomon, D.H., Haneuse, S., Kim, S.C., Patorno, E., Tedeschi, S.K., Lyu, H.,
Franklin, J.M., StÃ¼rmer, T., HernÃ¡ndez-DÃ­az, S. and Glynn, R.J. (2019).
Multinomial extension of propensity score trimming methods: A simulation study.
American Journal of Epidemiology, 188(3), 609-616.
</p>
<p>Li, F., Li, F. (2019). Propensity score weighting for causal inference with multiple treatments.
The Annals of Applied Statistics, 13(4), 2389-2415.
</p>
<p>Zhou, Y., Matsouaka, R. A., Thomas, L. (2020).
Propensity score weighting under limited overlap and model misspecification. Statistical Methods in Medical Research 29(12), 3721-3756.
</p>


<h3>Examples</h3>

<pre><code class="language-R">#data("psdata_cl")
#ps.formula&lt;-trt~cov1+cov2+cov3+cov4+cov5+cov6+(1|clt)
#ato_cl&lt;-PSweight(ps.formula = ps.formula,yname = 'Y',data = psdata_cl)
#summary(ato_cl)


</code></pre>


</div>