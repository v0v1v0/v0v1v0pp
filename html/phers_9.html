<div class="container">

<table style="width: 100%;"><tr>
<td>getWeights</td>
<td style="text-align: right;">R Documentation</td>
</tr></table>
<h2>Calculate phecode-specific weights for phenotype risk scores</h2>

<h3>Description</h3>

<p>This is typically the second step of an analysis using phenotype risk scores,
the next is <code>getScores()</code>.
</p>


<h3>Usage</h3>

<pre><code class="language-R">getWeights(
  demos,
  phecodeOccurrences,
  method = c("prevalence", "logistic", "cox", "loglinear", "prevalence_precalc"),
  methodFormula = NULL,
  negativeWeights = FALSE,
  dopar = FALSE
)
</code></pre>


<h3>Arguments</h3>

<table>
<tr style="vertical-align: top;">
<td><code>demos</code></td>
<td>
<p>A data.table having one row per person in the cohort. Must have
a column <code>person_id</code>. When the <code>cox</code> method is used, <code>demos</code>
must have columns <code>first_age</code> and <code>last_age</code> corresponding to first and
last age of visit (in years).</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>phecodeOccurrences</code></td>
<td>
<p>A data.table of phecode occurrences for each person
in the cohort. Must have columns <code>person_id</code> and <code>phecode</code> under the
"prevalence" or "logistic" methods, columns <code>person_id</code>, <code>phecode</code>, and
<code>num_occurrences</code> under the "loglinear" method, and columns <code>person_id</code>,
<code>phecode</code>, and <code>occurrence_age</code> under the "cox" method. <code>num_occurrences</code>
refers to the number of unique dates a phecode was recorded for a person.
<code>occurrence_age</code> refers to the first age (in years) a person acquired a
phecode.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>method</code></td>
<td>
<p>A string indicating the statistical model for calculating
weights.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>methodFormula</code></td>
<td>
<p>A formula representing the right-hand side of the model
corresponding to <code>method</code>. All terms in the formula must correspond to
columns in <code>demos</code>. A method formula is not required for the "prevalence"
and "prevalence_precalc" methods. Do not use age-related covariates with
the "cox" method.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>negativeWeights</code></td>
<td>
<p>Logical indicating whether to allow negative weights
for individuals with no occurrences of a phecode. This option is not
required for the "loglinear" method since under this method, individuals
with a nonzero phecode occurrence can also have negative weights.</p>
</td>
</tr>
<tr style="vertical-align: top;">
<td><code>dopar</code></td>
<td>
<p>Logical indicating whether to run calculations in parallel if
a parallel backend is already set up, e.g., using
<code>doParallel::registerDoParallel()</code>. Recommended to minimize runtime.</p>
</td>
</tr>
</table>
<h3>Value</h3>

<p>A data.table with columns <code>person_id</code>, <code>phecode</code>, <code>pred</code>, and <code>w</code>.
The column <code>pred</code> represents a different quantity depending on <code>method</code>.
Under the "prevalence" <code>method</code>, it is fraction of the cohort that has
at least one occurrence of the given phecode. The "prevalence_precalc"
<code>method</code> is similar to the "prevalence" <code>method</code> but <code>pred</code> is calculated
based on EHR data from the Vanderbilt University Medical Center.
Under "logistic" or "cox" <code>method</code>, it is the predicted probability of
given individual having a given phecode based on <code>methodFormula</code>.
Under the "loglinear" <code>method</code>, it is the predicted
<code>log2(num_occurrences + 1)</code> of a given phecode for a given individual
based on <code>methodFormula</code>. For the "prevalence", "prevalence_precalc",
"cox", and "logistic" <code>method</code>s, weight is calculated as <code>-log10(pred)</code>
when an individual has non-zero phecode occurrence and <code>log10(1 - pred)</code>
when an individual has zero phecode occurrence. For the "loglinear" <code>method</code>
weight is calculated as the difference between the observed
<code>log2(num_occurrences + 1)</code> and <code>pred</code>.
</p>


<h3>See Also</h3>

<p><code>getPhecodeOccurrences()</code>, <code>getScores()</code>
</p>


<h3>Examples</h3>

<pre><code class="language-R">library('data.table')
library('survival')

# map ICD codes to phecodes
phecodeOccurrences = getPhecodeOccurrences(icdSample)

# calculate weights using the prevalence method
weightsPrev = getWeights(demoSample, phecodeOccurrences)

# calculate weights using the prevalence method
# (assign negative weights to those with zero phecode occurrence)
weightsPrevNeg = getWeights(
  demoSample, phecodeOccurrences, negativeWeights = TRUE)

# calculate weights using the logistic method
weightsLogistic = getWeights(
  demoSample, phecodeOccurrences, method = 'logistic', methodFormula = ~ sex)

# calculate weights using the loglinear method
phecodeOccurrences2 = phecodeOccurrences[, .(
  num_occurrences = uniqueN(entry_date)), by = .(person_id, phecode)]
weightsLoglinear = getWeights(
  demoSample, phecodeOccurrences2, method = 'loglinear', methodFormula = ~ sex)

# calculate weights using the cox method
phecodeOccurrences3 = phecodeOccurrences[, .(
  first_occurrence_date = min(entry_date)) , by = .(person_id, phecode)]
phecodeOccurrences3 = merge(
  phecodeOccurrences3, demoSample[, .(person_id, dob)], by = 'person_id')
phecodeOccurrences3[,
  occurrence_age := as.numeric((first_occurrence_date - dob)/365.25)]
phecodeOccurrences3[, `:=`(first_occurrence_date = NULL, dob = NULL)]
demoSample3 = demoSample[, .(
  person_id, sex,
  first_age = as.numeric((first_visit_date - dob)/365.25),
  last_age = as.numeric((last_visit_date - dob)/365.25))]
weightsCox = getWeights(
  demoSample3, phecodeOccurrences3, method = 'cox', methodFormula = ~ sex)

# calculate weights using pre-calculated weights based on data from
# Vanderbilt University Medical Center
weightsPreCalc = getWeights(
  demoSample, phecodeOccurrences, method = 'prevalence_precalc')
</code></pre>


</div>